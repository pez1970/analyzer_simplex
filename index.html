<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador EDA - SimpleXü¶â</title>
    
    <!-- Librer√≠as principales - orden espec√≠fico -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    
    <!-- Librer√≠as opcionales -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Configuraci√≥n simple post-carga -->
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Verificar estado de librer√≠as
                console.log('Librer√≠as cargadas:', {
                    'Papa Parse': typeof Papa !== 'undefined',
                    'Chart.js': typeof Chart !== 'undefined',
                    'Lodash': typeof _ !== 'undefined',
                    'html2canvas': typeof html2canvas !== 'undefined'
                });
                
                // Inicializar aplicaci√≥n
                initializeApp();
            }, 300);
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            font-weight: 300;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .upload-section:hover {
            transform: translateY(-5px);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: linear-gradient(45deg, #f8f9ff, #e8ecff);
            color: #667eea;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            min-height: 100px;
        }

        .file-input-button:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #e8ecff, #dde4ff);
            transform: scale(1.02);
        }

        .file-input-button.dragover {
            border-color: #4fd1c7;
            background: linear-gradient(45deg, #e6fffa, #b2f5ea);
            color: #319795;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            border-left: 4px solid #48bb78;
            display: none;
        }

        .analysis-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .column-selector {
            margin-bottom: 30px;
        }

        .column-selector h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-button {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .column-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .column-item label {
            font-weight: 500;
            color: #4a5568;
            cursor: pointer;
        }

        .analyze-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .analyze-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .analyze-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            display: none;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: #f7fafc;
            padding: 5px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9em;
            text-align: center;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #4a5568;
        }

        .stat-value {
            color: #2d3748;
            font-weight: 600;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.3em;
            font-weight: 600;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .correlation-matrix {
            overflow-x: auto;
            margin: 20px 0;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .correlation-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .correlation-cell {
            font-weight: 600;
            color: white;
            border-radius: 4px;
        }

        .custom-chart-builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 20px;
        }

        .chart-controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 0.95em;
        }

        .chart-select, .chart-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.3s ease;
        }

        .chart-select:focus, .chart-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .create-chart-button {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .create-chart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .create-chart-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .custom-charts-display {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .no-charts-message {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
            font-style: italic;
        }

        .custom-chart-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .custom-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
        }

        .delete-chart-button {
            background: #fed7d7;
            color: #c53030;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s ease;
        }

        .delete-chart-button:hover {
            background: #fc8181;
            color: white;
        }

        .export-section {
            max-width: 1000px;
            margin: 0 auto;
        }

        .export-options {
            display: grid;
            gap: 25px;
        }

        .export-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .export-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .export-card.featured {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border: 2px solid #48bb78;
        }

        .export-card-header h4 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-card-header p {
            color: #718096;
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .export-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-button.primary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 3px 12px rgba(72, 187, 120, 0.3);
        }

        .export-button.primary:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .checkbox-option input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #48bb78;
        }

        .checkbox-option span {
            color: #2d3748;
            font-weight: 500;
        }

        .config-options {
            display: grid;
            gap: 15px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95em;
        }

        .config-input, .config-select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.3s ease;
        }

        .config-input:focus, .config-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            color: #2d3748;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .column-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .custom-chart-builder {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1 1 auto;
                min-width: 80px;
                font-size: 0.8em;
                padding: 8px 6px;
            }

            .export-buttons {
                flex-direction: column;
            }

            .export-button {
                width: 100%;
                text-align: center;
            }

            .report-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Procesando an√°lisis...</h3>
            <p id="loadingMessage">Por favor, espera mientras procesamos los datos</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Analizador EDA</h1>
            <p class="subtitle">An√°lisis Exploratorio de Datos para archivos CSV- Herramienta de SimpleX</p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <section class="upload-section">
            <h2>Cargar archivo CSV</h2>
            <p style="margin-bottom: 20px; color: #4a5568;">
                Sube tu archivo CSV (m√°ximo 20MB). Debe tener encabezados en la primera fila, separaci√≥n por comas y codificaci√≥n UTF-8.
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" id="csvFile" accept=".csv" />
                <label for="csvFile" class="file-input-button" id="fileInputButton">
                    <span class="upload-icon">üì§</span>
                    <span>Haz clic aqu√≠ o arrastra tu archivo CSV</span>
                </label>
            </div>
            
            <div class="file-info" id="fileInfo"></div>
        </section>

        <section class="analysis-section" id="analysisSection">
            <div class="column-selector">
                <h3>Selecciona las columnas a analizar</h3>
                <div class="selection-controls" style="margin-bottom: 15px;">
                    <button class="control-button" id="selectAllButton">Seleccionar todas</button>
                    <button class="control-button" id="deselectAllButton">Deseleccionar todas</button>
                    <button class="control-button" id="selectNumericButton">Solo num√©ricas</button>
                </div>
                <div class="column-grid" id="columnGrid"></div>
                <button class="analyze-button" id="analyzeButton" disabled>
                    Iniciar An√°lisis EDA
                </button>
            </div>
        </section>

        <section class="results-section" id="resultsSection">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="overview">Resumen</button>
                    <button class="tab-button" data-tab="statistics">Estad√≠sticas</button>
                    <button class="tab-button" data-tab="visualizations">Visualizaciones</button>
                    <button class="tab-button" data-tab="custom-charts">Gr√°ficas</button>
                    <button class="tab-button" data-tab="correlations">Correlaciones</button>
                    <button class="tab-button" data-tab="quality">Calidad</button>
                    <button class="tab-button" data-tab="export">Exportar</button>
                </div>

                <div class="tab-content active" id="overview">
                    <h3>Resumen General del Dataset</h3>
                    <div id="overviewContent"></div>
                </div>

                <div class="tab-content" id="statistics">
                    <h3>Estad√≠sticas Descriptivas</h3>
                    <div id="statisticsContent"></div>
                </div>

                <div class="tab-content" id="visualizations">
                    <h3>Visualizaciones Autom√°ticas</h3>
                    <div id="visualizationsContent"></div>
                </div>

                <div class="tab-content" id="custom-charts">
                    <h3>Crear Gr√°ficas Personalizadas</h3>
                    <div class="custom-chart-builder">
                        <div class="chart-controls">
                            <div class="control-group">
                                <label for="chartType"><strong>Tipo de Gr√°fica:</strong></label>
                                <select id="chartType" class="chart-select">
                                    <option value="scatter">Scatter Plot (Dispersi√≥n)</option>
                                    <option value="histogram">Histograma</option>
                                    <option value="pie">Gr√°fico de Pie</option>
                                    <option value="bar">Gr√°fico de Barras</option>
                                    <option value="line">Gr√°fico de L√≠neas</option>
                                </select>
                            </div>

                            <div class="control-group" id="xAxisGroup">
                                <label for="xAxisVariable"><strong>Variable X:</strong></label>
                                <select id="xAxisVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group" id="yAxisGroup">
                                <label for="yAxisVariable"><strong>Variable Y:</strong></label>
                                <select id="yAxisVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group" id="categoryGroup" style="display: none;">
                                <label for="categoryVariable"><strong>Variable de Categor√≠a:</strong></label>
                                <select id="categoryVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="chartTitle"><strong>T√≠tulo de la Gr√°fica:</strong></label>
                                <input type="text" id="chartTitle" class="chart-input" placeholder="Mi gr√°fica personalizada" />
                            </div>

                            <button class="create-chart-button" id="createCustomChart">
                                Crear Gr√°fica Personalizada
                            </button>
                        </div>

                        <div id="customChartsContainer" class="custom-charts-display">
                            <div class="no-charts-message">
                                <p>Crea tu primera gr√°fica personalizada seleccionando el tipo y las variables</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="correlations">
                    <h3>Matriz de Correlaciones</h3>
                    <div id="correlationsContent"></div>
                </div>

                <div class="tab-content" id="quality">
                    <h3>An√°lisis de Calidad de Datos</h3>
                    <div id="qualityContent"></div>
                </div>

                <div class="tab-content" id="export">
                    <h3>Exportar An√°lisis</h3>
                    <div class="export-section">
                        <div class="export-options">
                            <div class="export-card">
                                <div class="export-card-header">
                                    <h4>Exportar Datos</h4>
                                    <p>Descarga los datos analizados en diferentes formatos</p>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button" id="exportFilteredCSV">
                                        Datos Filtrados (CSV)
                                    </button>
                                    <button class="export-button" id="exportStatistics">
                                        Estad√≠sticas (CSV)
                                    </button>
                                </div>
                            </div>

                            <div class="export-card">
                                <div class="export-card-header">
                                    <h4>Exportar Gr√°ficos</h4>
                                    <p>Descarga visualizaciones individuales</p>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button" id="exportAllCharts">
                                        Todos los Gr√°ficos (PNG)
                                    </button>
                                </div>
                            </div>

                            <div class="export-card featured">
                                <div class="export-card-header">
                                    <h4>üìÑ Generar Reporte Completo</h4>
                                    <p>Crea un reporte profesional con todos los an√°lisis</p>
                                </div>
                                <div class="report-options">
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeOverview" checked>
                                        <span>Incluir Resumen General</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeStatistics" checked>
                                        <span>Incluir Estad√≠sticas Descriptivas</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeVisualizations" checked>
                                        <span>Incluir Visualizaciones Autom√°ticas</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeCustomCharts" checked>
                                        <span>Incluir Gr√°ficos Personalizados</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeCorrelations" checked>
                                        <span>Incluir Matrix de Correlaciones</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeQuality" checked>
                                        <span>Incluir An√°lisis de Calidad</span>
                                    </label>
                                </div>
                                <div class="config-options">
                                    <div class="config-group">
                                        <label for="reportTitle">T√≠tulo del Reporte:</label>
                                        <input type="text" id="reportTitle" class="config-input" placeholder="An√°lisis EDA - Mi Dataset" />
                                    </div>
                                    <div class="config-group">
                                        <label for="authorName">Autor:</label>
                                        <input type="text" id="authorName" class="config-input" placeholder="Tu nombre" />
                                    </div>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button primary" id="generateHTMLReport">
                                        üåê Generar Reporte HTML
                                    </button>
                                </div>
                            </div>

                            <div class="export-card" style="background: linear-gradient(135deg, #e6f7ff, #f0f9ff); border: 2px solid #1890ff;">
                                <div class="export-card-header">
                                    <h4>üì± ¬øNecesitas un PDF?</h4>
                                    <p>Convierte f√°cilmente el reporte HTML a PDF</p>
                                </div>
                                <div style="background: white; padding: 20px; border-radius: 8px; margin: 15px 0;">
                                    <h5 style="margin-bottom: 15px; color: #1890ff;">Instrucciones simples:</h5>
                                    <ol style="margin: 0; padding-left: 20px; color: #2d3748; line-height: 1.6;">
                                        <li><strong>Genera el reporte HTML</strong> usando el bot√≥n de arriba</li>
                                        <li><strong>Abre el archivo</strong> en tu navegador (Chrome, Firefox, Edge, Safari)</li>
                                        <li><strong>Presiona Ctrl+P</strong> (o Cmd+P en Mac) para abrir las opciones de impresi√≥n</li>
                                        <li><strong>Selecciona "Guardar como PDF"</strong> en lugar de impresora</li>
                                        <li><strong>Ajusta m√°rgenes</strong> a "M√≠nimo" para mejor formato</li>
                                        <li><strong>Haz clic en "Guardar"</strong> y elige la ubicaci√≥n</li>
                                    </ol>
                                    <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #1890ff;">
                                        <strong>‚ú® Resultado:</strong> PDF profesional id√©ntico al reporte, con gr√°ficos de alta calidad y formato perfecto.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Variables globales optimizadas
        let csvData = null;
        let selectedColumns = [];
        let dataTypes = {};
        let customChartCounter = 0;
        let analysisData = null;
        
        // Cache de elementos DOM para mejor rendimiento
        const DOM = {
            csvFileInput: null,
            fileInputButton: null,
            fileInfo: null,
            analysisSection: null,
            columnGrid: null,
            analyzeButton: null,
            resultsSection: null,
            errorMessage: null,
            loadingOverlay: null,
            init() {
                this.csvFileInput = document.getElementById('csvFile');
                this.fileInputButton = document.getElementById('fileInputButton');
                this.fileInfo = document.getElementById('fileInfo');
                this.analysisSection = document.getElementById('analysisSection');
                this.columnGrid = document.getElementById('columnGrid');
                this.analyzeButton = document.getElementById('analyzeButton');
                this.resultsSection = document.getElementById('resultsSection');
                this.errorMessage = document.getElementById('errorMessage');
                this.loadingOverlay = document.getElementById('loadingOverlay');
            }
        };

        function initializeApp() {
            DOM.init();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Archivo CSV
            DOM.csvFileInput.addEventListener('change', handleFileSelect);
            DOM.analyzeButton.addEventListener('click', performAnalysis);

            // Controles de columnas
            document.getElementById('selectAllButton').addEventListener('click', selectAllColumns);
            document.getElementById('deselectAllButton').addEventListener('click', deselectAllColumns);
            document.getElementById('selectNumericButton').addEventListener('click', selectNumericColumns);

            // Gr√°ficas personalizadas
            document.getElementById('chartType').addEventListener('change', updateChartControls);
            document.getElementById('createCustomChart').addEventListener('click', createCustomChartFunction);

            // Exportaci√≥n
            document.getElementById('exportFilteredCSV').addEventListener('click', () => exportData('filtered'));
            document.getElementById('exportStatistics').addEventListener('click', () => exportData('statistics'));
            document.getElementById('exportAllCharts').addEventListener('click', () => exportCharts('all'));
            document.getElementById('generateHTMLReport').addEventListener('click', () => generateReport('html'));

            // Drag and drop
            setupDragAndDrop();

            // Tabs
            setupTabs();
        }

        function setupDragAndDrop() {
            DOM.fileInputButton.addEventListener('dragover', (e) => {
                e.preventDefault();
                DOM.fileInputButton.classList.add('dragover');
            });

            DOM.fileInputButton.addEventListener('dragleave', () => {
                DOM.fileInputButton.classList.remove('dragover');
            });

            DOM.fileInputButton.addEventListener('drop', (e) => {
                e.preventDefault();
                DOM.fileInputButton.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    DOM.csvFileInput.files = files;
                    handleFileSelect();
                }
            });
        }

        function setupTabs() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
        }

        function showError(message) {
            DOM.errorMessage.textContent = message;
            DOM.errorMessage.style.display = 'block';
            setTimeout(() => {
                DOM.errorMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show, title = 'Procesando...', message = 'Por favor, espera') {
            DOM.loadingOverlay.style.display = show ? 'flex' : 'none';
            if (show) {
                document.getElementById('loadingTitle').textContent = title;
                document.getElementById('loadingMessage').textContent = message;
            }
        }

        function handleFileSelect() {
            const file = DOM.csvFileInput.files[0];
            if (!file) return;

            if (file.size > 20 * 1024 * 1024) {
                showError('El archivo es demasiado grande. El l√≠mite es de 20MB.');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Por favor, selecciona un archivo CSV v√°lido.');
                return;
            }

            DOM.fileInfo.innerHTML = `
                <strong>Archivo seleccionado:</strong> ${file.name}<br>
                <strong>Tama√±o:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>√öltima modificaci√≥n:</strong> ${new Date(file.lastModified).toLocaleString('es-ES')}
            `;
            DOM.fileInfo.style.display = 'block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const results = Papa.parse(e.target.result, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.trim(),
                        dynamicTyping: true
                    });

                    if (results.errors.length > 0) {
                        showError('Error al procesar el CSV: ' + results.errors[0].message);
                        return;
                    }

                    csvData = results.data;
                    setupColumnSelector();
                    DOM.analysisSection.style.display = 'block';
                    
                } catch (error) {
                    showError('Error al leer el archivo: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function setupColumnSelector() {
            if (!csvData || csvData.length === 0) return;

            const headers = Object.keys(csvData[0]);
            DOM.columnGrid.innerHTML = '';

            // Detecci√≥n mejorada de tipos de datos
            dataTypes = detectDataTypes(headers);

            headers.forEach((header, index) => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col-${index}`;
                checkbox.value = header;
                checkbox.checked = dataTypes[header] === 'numeric';
                
                const label = document.createElement('label');
                label.htmlFor = `col-${index}`;
                label.innerHTML = `${header} <small style="color: #718096;">(${dataTypes[header]})</small>`;
                
                checkbox.addEventListener('change', updateSelectedColumns);
                
                columnItem.appendChild(checkbox);
                columnItem.appendChild(label);
                DOM.columnGrid.appendChild(columnItem);
            });

            updateSelectedColumns();
        }

        function detectDataTypes(headers) {
            const types = {};
            const sampleSize = Math.min(100, csvData.length);
            
            headers.forEach(header => {
                const sample = csvData.slice(0, sampleSize)
                    .map(row => row[header])
                    .filter(val => val !== null && val !== undefined && val !== '');
                
                if (sample.length === 0) {
                    types[header] = 'empty';
                    return;
                }
                
                // Verificar num√©rico
                const numericCount = sample.filter(val => !isNaN(val) && isFinite(val)).length;
                if (numericCount / sample.length > 0.8) {
                    types[header] = 'numeric';
                    return;
                }
                
                // Verificar fechas
                const dateCount = sample.filter(val => !isNaN(Date.parse(val))).length;
                if (dateCount / sample.length > 0.8) {
                    types[header] = 'datetime';
                    return;
                }
                
                types[header] = 'categorical';
            });
            
            return types;
        }

        function updateSelectedColumns() {
            selectedColumns = Array.from(document.querySelectorAll('.column-item input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            DOM.analyzeButton.disabled = selectedColumns.length === 0;
        }

        function selectAllColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedColumns();
        }

        function deselectAllColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedColumns();
        }

        function selectNumericColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                const columnName = checkbox.value;
                checkbox.checked = dataTypes[columnName] === 'numeric';
            });
            updateSelectedColumns();
        }

        function performAnalysis() {
            if (selectedColumns.length === 0) {
                showError('Selecciona al menos una columna para analizar.');
                return;
            }

            showLoading(true, 'Analizando datos...', 'Procesando columnas seleccionadas');

            DOM.resultsSection.style.display = 'block';
            DOM.resultsSection.scrollIntoView({ behavior: 'smooth' });

            setTimeout(() => {
                try {
                    const filteredData = csvData.map(row => {
                        const filteredRow = {};
                        selectedColumns.forEach(col => {
                            filteredRow[col] = row[col];
                        });
                        return filteredRow;
                    });

                    generateOverview(filteredData);
                    generateStatistics(filteredData);
                    generateVisualizations(filteredData);
                    generateCorrelations(filteredData);
                    generateQualityAnalysis(filteredData);
                    
                    populateCustomChartVariables();
                    
                    analysisData = {
                        original: csvData,
                        filtered: filteredData,
                        columns: selectedColumns,
                        types: dataTypes
                    };
                    
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showError('Error durante el an√°lisis: ' + error.message);
                }
            }, 500);
        }

        function generateOverview(data) {
            const totalRows = data.length;
            const totalColumns = selectedColumns.length;
            const numericColumns = selectedColumns.filter(col => dataTypes[col] === 'numeric').length;
            const categoricalColumns = selectedColumns.filter(col => dataTypes[col] === 'categorical').length;

            let memoryUsage = 0;
            selectedColumns.forEach(col => {
                const values = data.map(row => row[col]).filter(val => val !== null && val !== undefined);
                memoryUsage += values.length * (dataTypes[col] === 'numeric' ? 8 : 50);
            });

            document.getElementById('overviewContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Informaci√≥n General</h4>
                        <div class="stat-item"><span class="stat-label">Total de filas:</span><span class="stat-value">${totalRows.toLocaleString()}</span></div>
                        <div class="stat-item"><span class="stat-label">Total de columnas analizadas:</span><span class="stat-value">${totalColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Columnas num√©ricas:</span><span class="stat-value">${numericColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Columnas categ√≥ricas:</span><span class="stat-value">${categoricalColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Uso estimado de memoria:</span><span class="stat-value">${(memoryUsage / 1024 / 1024).toFixed(2)} MB</span></div>
                    </div>
                </div>
            `;
        }

        function generateStatistics(data) {
            const statsContent = document.getElementById('statisticsContent');
            statsContent.innerHTML = '<div class="loading">Generando estad√≠sticas...</div>';

            setTimeout(() => {
                let html = '<div class="stats-grid">';

                selectedColumns.forEach(column => {
                    const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && val !== '');
                    
                    if (dataTypes[column] === 'numeric') {
                        const numericValues = values.map(Number).filter(val => !isNaN(val));
                        if (numericValues.length > 0) {
                            const stats = calculateNumericStats(numericValues);
                            html += `
                                <div class="stat-card">
                                    <h4>${column}</h4>
                                    <div class="stat-item"><span class="stat-label">Cantidad:</span><span class="stat-value">${stats.count}</span></div>
                                    <div class="stat-item"><span class="stat-label">Media:</span><span class="stat-value">${stats.mean.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Mediana:</span><span class="stat-value">${stats.median.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Desv. Est√°ndar:</span><span class="stat-value">${stats.std.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">M√≠nimo:</span><span class="stat-value">${stats.min}</span></div>
                                    <div class="stat-item"><span class="stat-label">M√°ximo:</span><span class="stat-value">${stats.max}</span></div>
                                    <div class="stat-item"><span class="stat-label">Q1 (25%):</span><span class="stat-value">${stats.q1.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Q3 (75%):</span><span class="stat-value">${stats.q3.toFixed(2)}</span></div>
                                </div>
                            `;
                        }
                    } else {
                        const counts = _.countBy(values);
                        const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                        const topValues = sortedCounts.slice(0, 5);

                        html += `
                            <div class="stat-card">
                                <h4>${column} (Categ√≥rica)</h4>
                                <div class="stat-item"><span class="stat-label">Valores √∫nicos:</span><span class="stat-value">${Object.keys(counts).length}</span></div>
                                <div class="stat-item"><span class="stat-label">Valor m√°s frecuente:</span><span class="stat-value">${sortedCounts[0][0]} (${sortedCounts[0][1]})</span></div>
                                <div style="margin-top: 10px;"><strong>Top 5 valores:</strong></div>
                                ${topValues.map(([value, count]) => 
                                    `<div class="stat-item"><span class="stat-label">${value}:</span><span class="stat-value">${count}</span></div>`
                                ).join('')}
                            </div>
                        `;
                    }
                });

                html += '</div>';
                statsContent.innerHTML = html;
            }, 100);
        }

        function calculateNumericStats(values) {
            const sorted = values.sort((a, b) => a - b);
            const mean = _.mean(values);
            
            return {
                count: values.length,
                mean: mean,
                median: sorted[Math.floor(sorted.length / 2)],
                std: Math.sqrt(_.mean(values.map(x => Math.pow(x - mean, 2)))),
                min: _.min(values),
                max: _.max(values),
                q1: sorted[Math.floor(sorted.length * 0.25)],
                q3: sorted[Math.floor(sorted.length * 0.75)]
            };
        }

        function generateVisualizations(data) {
            const vizContent = document.getElementById('visualizationsContent');
            vizContent.innerHTML = '<div class="loading">Generando visualizaciones...</div>';

            setTimeout(() => {
                let html = '';
                let chartIndex = 0;

                selectedColumns.forEach(column => {
                    if (dataTypes[column] === 'numeric') {
                        const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && !isNaN(val));
                        
                        if (values.length > 0) {
                            const chartId = `chart-${chartIndex++}`;
                            html += `
                                <div class="chart-container">
                                    <div class="chart-title">Histograma - ${column}</div>
                                    <canvas id="${chartId}" width="400" height="200"></canvas>
                                </div>
                            `;

                            setTimeout(() => {
                                const ctx = document.getElementById(chartId);
                                if (ctx) {
                                    createHistogram(ctx, values, column);
                                }
                            }, 100);
                        }
                    } else {
                        const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && val !== '');
                        const counts = _.countBy(values);
                        const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);

                        if (sortedCounts.length > 0) {
                            const chartId = `chart-${chartIndex++}`;
                            html += `
                                <div class="chart-container">
                                    <div class="chart-title">Distribuci√≥n - ${column}</div>
                                    <canvas id="${chartId}" width="400" height="200"></canvas>
                                </div>
                            `;

                            setTimeout(() => {
                                const ctx = document.getElementById(chartId);
                                if (ctx) {
                                    createBarChart(ctx, sortedCounts, column);
                                }
                            }, 100);
                        }
                    }
                });

                vizContent.innerHTML = html;
            }, 100);
        }

        function createHistogram(ctx, values, title) {
            const min = Math.min(...values);
            const max = Math.max(...values);
            const bins = 15;
            const binWidth = (max - min) / bins;
            
            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = min + (i + 1) * binWidth;
                labels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);
                
                histogram[i] = values.filter(val => val >= binStart && (i === bins - 1 ? val <= binEnd : val < binEnd)).length;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: histogram,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Frecuencia' }
                        },
                        x: {
                            title: { display: true, text: title }
                        }
                    }
                }
            });
        }

        function createBarChart(ctx, data, title) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [{
                        label: 'Frecuencia',
                        data: data.map(item => item[1]),
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Frecuencia' }
                        }
                    }
                }
            });
        }

        function generateCorrelations(data) {
            const corrContent = document.getElementById('correlationsContent');
            const numericColumns = selectedColumns.filter(col => dataTypes[col] === 'numeric');

            if (numericColumns.length < 2) {
                corrContent.innerHTML = '<p>Se necesitan al menos 2 columnas num√©ricas para calcular correlaciones.</p>';
                return;
            }

            corrContent.innerHTML = '<div class="loading">Calculando correlaciones...</div>';

            setTimeout(() => {
                const correlationMatrix = calculateCorrelationMatrix(data, numericColumns);
                
                let html = `
                    <div class="correlation-matrix">
                        <table class="correlation-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    ${numericColumns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                numericColumns.forEach((row, i) => {
                    html += `<tr><th>${row}</th>`;
                    numericColumns.forEach((col, j) => {
                        const corr = correlationMatrix[i][j];
                        const intensity = Math.abs(corr);
                        const color = corr > 0 ? 
                            `rgba(72, 187, 120, ${intensity})` : 
                            `rgba(245, 101, 101, ${intensity})`;
                        
                        html += `<td class="correlation-cell" style="background-color: ${color}">
                            ${corr.toFixed(3)}
                        </td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                corrContent.innerHTML = html;
            }, 100);
        }

        function calculateCorrelationMatrix(data, columns) {
            const matrix = [];
            
            for (let i = 0; i < columns.length; i++) {
                matrix[i] = [];
                for (let j = 0; j < columns.length; j++) {
                    if (i === j) {
                        matrix[i][j] = 1;
                    } else {
                        const values1 = data.map(row => Number(row[columns[i]])).filter(val => !isNaN(val));
                        const values2 = data.map(row => Number(row[columns[j]])).filter(val => !isNaN(val));
                        matrix[i][j] = calculateCorrelation(values1, values2);
                    }
                }
            }
            return matrix;
        }

        function calculateCorrelation(x, y) {
            const n = Math.min(x.length, y.length);
            if (n < 2) return 0;

            const meanX = _.mean(x.slice(0, n));
            const meanY = _.mean(y.slice(0, n));

            let numerator = 0;
            let sumSqX = 0;
            let sumSqY = 0;

            for (let i = 0; i < n; i++) {
                const diffX = x[i] - meanX;
                const diffY = y[i] - meanY;
                numerator += diffX * diffY;
                sumSqX += diffX * diffX;
                sumSqY += diffY * diffY;
            }

            const denominator = Math.sqrt(sumSqX * sumSqY);
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function generateQualityAnalysis(data) {
            const qualityContent = document.getElementById('qualityContent');
            qualityContent.innerHTML = '<div class="loading">Analizando calidad de datos...</div>';

            setTimeout(() => {
                let html = '<div class="stats-grid">';

                selectedColumns.forEach(column => {
                    const totalRows = data.length;
                    const values = data.map(row => row[column]);
                    const nullValues = values.filter(val => val === null || val === undefined || val === '').length;
                    const validValues = totalRows - nullValues;
                    const uniqueValues = new Set(values.filter(val => val !== null && val !== undefined && val !== '')).size;

                    let outliers = 0;
                    if (dataTypes[column] === 'numeric') {
                        const numericValues = values.map(Number).filter(val => !isNaN(val));
                        if (numericValues.length > 0) {
                            outliers = detectOutliers(numericValues);
                        }
                    }

                    html += `
                        <div class="stat-card">
                            <h4>${column}</h4>
                            <div class="stat-item">
                                <span class="stat-label">Valores v√°lidos:</span>
                                <span class="stat-value">${validValues} (${(validValues/totalRows*100).toFixed(1)}%)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valores faltantes:</span>
                                <span class="stat-value">${nullValues} (${(nullValues/totalRows*100).toFixed(1)}%)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valores √∫nicos:</span>
                                <span class="stat-value">${uniqueValues}</span>
                            </div>
                            ${dataTypes[column] === 'numeric' ? `
                                <div class="stat-item">
                                    <span class="stat-label">Outliers detectados:</span>
                                    <span class="stat-value">${outliers} (${(outliers/totalRows*100).toFixed(1)}%)</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                qualityContent.innerHTML = html;
            }, 100);
        }

        function detectOutliers(values) {
            const sorted = values.sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const iqr = q3 - q1;
            const lowerBound = q1 - 1.5 * iqr;
            const upperBound = q3 + 1.5 * iqr;
            return values.filter(val => val < lowerBound || val > upperBound).length;
        }

        // Gr√°ficas personalizadas
        function populateCustomChartVariables() {
            const selects = ['xAxisVariable', 'yAxisVariable', 'categoryVariable'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Selecciona una variable...</option>';
                selectedColumns.forEach(column => {
                    const option = new Option(column, column);
                    select.add(option);
                });
            });

            updateChartControls();
        }

        function updateChartControls() {
            const selectedType = document.getElementById('chartType').value;
            const xAxisGroup = document.getElementById('xAxisGroup');
            const yAxisGroup = document.getElementById('yAxisGroup');
            const categoryGroup = document.getElementById('categoryGroup');

            // Reset visibility
            xAxisGroup.style.display = 'block';
            yAxisGroup.style.display = 'block';
            categoryGroup.style.display = 'none';

            switch(selectedType) {
                case 'histogram':
                    yAxisGroup.style.display = 'none';
                    xAxisGroup.querySelector('label').innerHTML = '<strong>Variable para Histograma:</strong>';
                    break;
                case 'pie':
                    xAxisGroup.style.display = 'none';
                    yAxisGroup.style.display = 'none';
                    categoryGroup.style.display = 'block';
                    break;
                case 'scatter':
                    xAxisGroup.querySelector('label').innerHTML = '<strong>Variable X (Horizontal):</strong>';
                    yAxisGroup.querySelector('label').innerHTML = '<strong>Variable Y (Vertical):</strong>';
                    break;
                case 'bar':
                case 'line':
                    xAxisGroup.querySelector('label').innerHTML = '<strong>Variable X (Categor√≠as/Tiempo):</strong>';
                    yAxisGroup.querySelector('label').innerHTML = '<strong>Variable Y (Valores):</strong>';
                    break;
            }
        }

        function createCustomChartFunction() {
            const selectedType = document.getElementById('chartType').value;
            const xVar = document.getElementById('xAxisVariable').value;
            const yVar = document.getElementById('yAxisVariable').value;
            const categoryVar = document.getElementById('categoryVariable').value;
            const title = document.getElementById('chartTitle').value || `Gr√°fica ${selectedType}`;

            // Validaciones
            if (selectedType === 'histogram' && !xVar) {
                showError('Selecciona una variable para el histograma.');
                return;
            }
            if (selectedType === 'pie' && !categoryVar) {
                showError('Selecciona una variable de categor√≠a para el gr√°fico de pie.');
                return;
            }
            if ((selectedType === 'scatter' || selectedType === 'bar' || selectedType === 'line') && (!xVar || !yVar)) {
                showError('Selecciona ambas variables X e Y para este tipo de gr√°fica.');
                return;
            }

            const chartId = `custom-chart-${customChartCounter++}`;
            createCustomChartElement(chartId, { type: selectedType, xVar, yVar, categoryVar, title });
        }

        function createCustomChartElement(chartId, options) {
            const noChartsMessage = document.querySelector('#customChartsContainer .no-charts-message');
            if (noChartsMessage) {
                noChartsMessage.remove();
            }

            const chartContainer = document.createElement('div');
            chartContainer.className = 'custom-chart-item';
            chartContainer.innerHTML = `
                <div class="custom-chart-header">
                    <div class="custom-chart-title">${options.title}</div>
                    <button class="delete-chart-button" onclick="deleteCustomChart(this)">Eliminar</button>
                </div>
                <canvas id="${chartId}" width="400" height="200"></canvas>
            `;

            document.getElementById('customChartsContainer').appendChild(chartContainer);

            setTimeout(() => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    generateCustomChart(canvas, options);
                }
            }, 100);
        }

        function generateCustomChart(canvas, options) {
            const filteredData = csvData.map(row => {
                const filteredRow = {};
                selectedColumns.forEach(col => {
                    filteredRow[col] = row[col];
                });
                return filteredRow;
            });

            switch(options.type) {
                case 'histogram':
                    createCustomHistogram(canvas, filteredData, options.xVar, options.title);
                    break;
                case 'pie':
                    createCustomPieChart(canvas, filteredData, options.categoryVar, options.title);
                    break;
                case 'scatter':
                    createCustomScatterPlot(canvas, filteredData, options.xVar, options.yVar, options.title);
                    break;
                case 'bar':
                    createCustomBarChart(canvas, filteredData, options.xVar, options.yVar, options.title);
                    break;
                case 'line':
                    createCustomLineChart(canvas, filteredData, options.xVar, options.yVar, options.title);
                    break;
            }
        }

        function createCustomHistogram(canvas, data, variable, title) {
            const values = data.map(row => Number(row[variable])).filter(val => !isNaN(val));
            if (values.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos num√©ricos v√°lidos para esta variable.</p>';
                return;
            }
            createHistogram(canvas, values, variable);
        }

        function createCustomPieChart(canvas, data, variable, title) {
            const values = data.map(row => row[variable]).filter(val => val !== null && val !== undefined && val !== '');
            const counts = _.countBy(values);
            const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            if (sortedCounts.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para esta variable.</p>';
                return;
            }

            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];

            new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: sortedCounts.map(item => item[0]),
                    datasets: [{
                        data: sortedCounts.map(item => item[1]),
                        backgroundColor: colors.slice(0, sortedCounts.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title },
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function createCustomScatterPlot(canvas, data, xVar, yVar, title) {
            const points = data.map(row => ({
                x: Number(row[xVar]),
                y: Number(row[yVar])
            })).filter(point => !isNaN(point.x) && !isNaN(point.y));

            if (points.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos num√©ricos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${xVar} vs ${yVar}`,
                        data: points,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title }
                    },
                    scales: {
                        x: { title: { display: true, text: xVar } },
                        y: { title: { display: true, text: yVar } }
                    }
                }
            });
        }

        function createCustomBarChart(canvas, data, xVar, yVar, title) {
            const groupedData = _.groupBy(data, xVar);
            const chartData = Object.entries(groupedData).map(([key, values]) => {
                const numericValues = values.map(v => Number(v[yVar])).filter(v => !isNaN(v));
                return {
                    label: key,
                    value: numericValues.length > 0 ? _.mean(numericValues) : 0
                };
            }).sort((a, b) => b.value - a.value).slice(0, 15);

            if (chartData.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.label),
                    datasets: [{
                        label: `Promedio de ${yVar}`,
                        data: chartData.map(item => item.value),
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: `Promedio de ${yVar}` }
                        },
                        x: { title: { display: true, text: xVar } }
                    }
                }
            });
        }

        function createCustomLineChart(canvas, data, xVar, yVar, title) {
            const sortedData = data.filter(row => 
                row[xVar] !== null && row[xVar] !== undefined && 
                row[yVar] !== null && row[yVar] !== undefined && !isNaN(Number(row[yVar]))
            ).sort((a, b) => {
                if (dataTypes[xVar] === 'numeric') {
                    return Number(a[xVar]) - Number(b[xVar]);
                }
                return a[xVar].localeCompare(b[xVar]);
            }).slice(0, 50);

            if (sortedData.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: sortedData.map(row => row[xVar]),
                    datasets: [{
                        label: yVar,
                        data: sortedData.map(row => Number(row[yVar])),
                        borderColor: 'rgba(245, 101, 101, 1)',
                        backgroundColor: 'rgba(245, 101, 101, 0.1)',
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: { display: true, text: title }
                    },
                    scales: {
                        x: { title: { display: true, text: xVar } },
                        y: { title: { display: true, text: yVar } }
                    }
                }
            });
        }

        function deleteCustomChart(button) {
            const chartItem = button.closest('.custom-chart-item');
            chartItem.remove();

            const container = document.getElementById('customChartsContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="no-charts-message">
                        <p>Crea tu primera gr√°fica personalizada seleccionando el tipo y las variables</p>
                    </div>
                `;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Funciones de exportaci√≥n simplificadas
        function downloadFile(content, filename, type = 'text/csv') {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportData(type) {
            if (!analysisData) {
                showError('No hay datos para exportar. Realiza primero un an√°lisis.');
                return;
            }

            showLoading(true, 'Exportando datos...', 'Preparando archivo CSV');

            setTimeout(() => {
                try {
                    let csvContent = '';
                    let filename = '';

                    switch(type) {
                        case 'filtered':
                            csvContent = generateCSVFromData(analysisData.filtered);
                            filename = 'datos_filtrados.csv';
                            break;
                        case 'statistics':
                            csvContent = generateStatisticsCSV();
                            filename = 'estadisticas.csv';
                            break;
                    }

                    downloadFile(csvContent, filename);
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showError('Error al exportar los datos: ' + error.message);
                }
            }, 300);
        }

        function generateCSVFromData(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (value === null || value === undefined) value = '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function generateStatisticsCSV() {
            let csvContent = 'Variable,M√©trica,Valor\n';
            
            analysisData.columns.forEach(column => {
                if (dataTypes[column] === 'numeric') {
                    const values = analysisData.filtered.map(row => Number(row[column])).filter(val => !isNaN(val));
                    if (values.length > 0) {
                        const stats = calculateNumericStats(values);
                        Object.entries(stats).forEach(([metric, value]) => {
                            csvContent += `"${column}","${metric}",${value}\n`;
                        });
                    }
                }
            });
            
            return csvContent;
        }

        function exportCharts(type) {
            showLoading(true, 'Exportando gr√°ficos...', 'Convirtiendo gr√°ficos a im√°genes PNG');
            
            setTimeout(() => {
                try {
                    const charts = [];
                    const canvases = document.querySelectorAll('canvas[id^="chart-"], canvas[id^="custom-chart-"]');
                    
                    canvases.forEach(canvas => {
                        const title = getChartTitle(canvas);
                        charts.push({
                            name: title,
                            data: canvas.toDataURL('image/png', 1.0)
                        });
                    });
                    
                    if (charts.length === 0) {
                        showError('No hay gr√°ficos disponibles para exportar.');
                        showLoading(false);
                        return;
                    }
                    
                    charts.forEach((chart, index) => {
                        const link = document.createElement('a');
                        link.download = `${chart.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                        link.href = chart.data;
                        document.body.appendChild(link);
                        
                        setTimeout(() => {
                            link.click();
                            document.body.removeChild(link);
                        }, index * 100);
                    });
                    
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showError('Error al exportar los gr√°ficos: ' + error.message);
                }
            }, 300);
        }

        function getChartTitle(canvas) {
            const container = canvas.closest('.chart-container, .custom-chart-item');
            if (container) {
                const titleElement = container.querySelector('.chart-title, .custom-chart-title');
                if (titleElement) {
                    return titleElement.textContent;
                }
            }
            return `Gr√°fico ${canvas.id}`;
        }

        function generateReport(format) {
            if (!analysisData) {
                showError('No hay datos para generar el reporte. Realiza primero un an√°lisis.');
                return;
            }

            showLoading(true, 'Generando reporte HTML...', 'Preparando reporte profesional con gr√°ficos integrados');

            setTimeout(() => {
                try {
                    const reportConfig = getReportConfig();
                    const htmlReport = generateHTMLReportContent(reportConfig);
                    const filename = `${reportConfig.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
                    
                    downloadFile(htmlReport, filename, 'text/html');
                    showLoading(false);
                    
                    // Mostrar instrucciones de conversi√≥n a PDF
                    setTimeout(() => {
                        showPDFConversionInstructions();
                    }, 1000);
                    
                } catch (error) {
                    showLoading(false);
                    showError('Error al generar el reporte: ' + error.message);
                }
            }, 500);
        }

        function showPDFConversionInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.7); z-index: 10000;
                display: flex; justify-content: center; align-items: center;
                padding: 20px; box-sizing: border-box;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; 
                           width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                        <h2 style="color: #2d3748; margin: 0 0 10px 0;">Reporte HTML Generado</h2>
                        <p style="color: #4a5568; margin: 0;">¬øQuieres convertirlo a PDF? Es muy f√°cil:</p>
                    </div>
                    
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <ol style="margin: 0; padding-left: 20px; color: #2d3748; line-height: 1.8;">
                            <li><strong>Abre el archivo HTML</strong> que se descarg√≥</li>
                            <li><strong>Presiona Ctrl+P</strong> (o Cmd+P en Mac)</li>
                            <li><strong>Selecciona "Guardar como PDF"</strong></li>
                            <li><strong>Ajusta m√°rgenes</strong> a "M√≠nimo"</li>
                            <li><strong>Guarda tu PDF</strong> profesional</li>
                        </ol>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; 
                               padding: 15px; border-radius: 8px; text-align: center; margin: 20px 0;">
                        <strong>Resultado: PDF de calidad profesional con todos los gr√°ficos</strong>
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()"
                               style="background: #667eea; color: white; border: none; padding: 12px 24px;
                                      border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
                                      transition: all 0.3s ease;">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function getReportConfig() {
            return {
                title: document.getElementById('reportTitle').value || 'An√°lisis EDA',
                author: document.getElementById('authorName').value || 'Usuario',
                date: new Date().toLocaleDateString('es-ES'),
                includeOverview: document.getElementById('includeOverview').checked,
                includeStatistics: document.getElementById('includeStatistics').checked,
                includeVisualizations: document.getElementById('includeVisualizations').checked,
                includeCustomCharts: document.getElementById('includeCustomCharts').checked,
                includeCorrelations: document.getElementById('includeCorrelations').checked,
                includeQuality: document.getElementById('includeQuality').checked
            };
        }

        function generateHTMLReportContent(config) {
            let html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${config.title}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; color: #333; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #667eea; }
                        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
                        .meta { color: #666; font-size: 1.1em; }
                        .section { margin: 30px 0; page-break-inside: avoid; }
                        .section h2 { color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; break-inside: avoid; }
                        .stat-item { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #e2e8f0; }
                        .chart-container { text-align: center; margin: 30px 0; page-break-inside: avoid; }
                        .chart-image { max-width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
                        .correlation-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .correlation-table th, .correlation-table td { padding: 8px 12px; text-align: center; border: 1px solid #e2e8f0; font-size: 0.9em; }
                        .correlation-table th { background: #f7fafc; }
                        
                        @media print {
                            body { margin: 15mm; font-size: 11pt; }
                            .section { page-break-inside: avoid; margin-bottom: 15mm; }
                            .chart-container { page-break-inside: avoid; margin: 10mm 0; }
                            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${config.title}</h1>
                        <div class="meta">
                            <p><strong>Autor:</strong> ${config.author}</p>
                            <p><strong>Fecha:</strong> ${config.date}</p>
                            <p><strong>Dataset:</strong> ${DOM.csvFileInput.files[0]?.name || 'Datos analizados'}</p>
                        </div>
                    </div>
            `;

            // Incluir secciones seg√∫n configuraci√≥n
            if (config.includeOverview) {
                html += generateReportSection('Resumen General', 'overviewContent');
            }
            
            if (config.includeStatistics) {
                html += generateReportSection('Estad√≠sticas Descriptivas', 'statisticsContent');
            }
            
            if (config.includeVisualizations || config.includeCustomCharts) {
                html += '<div class="section"><h2>Visualizaciones</h2>';
                
                if (config.includeVisualizations) {
                    document.querySelectorAll('canvas[id^="chart-"]').forEach(canvas => {
                        const title = getChartTitle(canvas);
                        const imageData = canvas.toDataURL('image/png', 1.0);
                        html += `
                            <div class="chart-container">
                                <h3>${title}</h3>
                                <img src="${imageData}" alt="${title}" class="chart-image" />
                            </div>
                        `;
                    });
                }
                
                if (config.includeCustomCharts) {
                    document.querySelectorAll('canvas[id^="custom-chart-"]').forEach(canvas => {
                        const title = getChartTitle(canvas);
                        const imageData = canvas.toDataURL('image/png', 1.0);
                        html += `
                            <div class="chart-container">
                                <h3>${title}</h3>
                                <img src="${imageData}" alt="${title}" class="chart-image" />
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
            }
            
            if (config.includeCorrelations) {
                html += generateReportSection('Matriz de Correlaciones', 'correlationsContent');
            }
            
            if (config.includeQuality) {
                html += generateReportSection('An√°lisis de Calidad de Datos', 'qualityContent');
            }

            html += `
                    <div class="section" style="margin-top: 50px; text-align: center; color: #666; font-size: 0.9em;">
                        <p>Reporte generado por Analizador EDA - ${new Date().toLocaleString('es-ES')}</p>
                        <p style="margin-top: 10px;"><em>Para convertir a PDF: Ctrl+P ‚Üí Guardar como PDF</em></p>
                    </div>
                </body>
                </html>
            `;

            return html;
        }

        function generateReportSection(title, contentId) {
            const contentElement = document.getElementById(contentId);
            if (!contentElement) return '';
            
            const clonedContent = contentElement.cloneNode(true);
            clonedContent.querySelectorAll('.loading, button, .delete-chart-button').forEach(el => el.remove());
            
            return `
                <div class="section">
                    <h2>${title}</h2>
                    ${clonedContent.innerHTML}
                </div>
            `;
        }

        // Funci√≥n global para eliminar gr√°ficos personalizados (necesaria para onclick)
        window.deleteCustomChart = deleteCustomChart;
    </script>
</body>
</html> 
