<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador EDA - SimpleX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    
    <!-- Sistema de carga con fallbacks para jsPDF -->
    <script>
        (function() {
            const jsPDFSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                'https://github.com/parallax/jsPDF/releases/download/v2.5.1/jspdf.umd.min.js'
            ];
            
            const html2canvasSources = [
                'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
                'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
            ];
            
            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        console.log(`üì• Script cargado: ${src}`);
                        resolve(src);
                    };
                    script.onerror = () => {
                        console.warn(`‚ùå Error cargando: ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    };
                    document.head.appendChild(script);
                });
            }
            
            async function loadWithFallback(sources, checkFunction, libraryName) {
                console.log(`üîÑ Intentando cargar ${libraryName}...`);
                
                for (let i = 0; i < sources.length; i++) {
                    const src = sources[i];
                    console.log(`üì° Intento ${i + 1}/${sources.length} para ${libraryName}: ${src}`);
                    
                    try {
                        await loadScript(src);
                        // Esperar un momento para que la librer√≠a se inicialice
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                        if (checkFunction()) {
                            console.log(`‚úÖ ${libraryName} cargado exitosamente desde: ${src}`);
                            return true;
                        } else {
                            console.warn(`‚ö†Ô∏è ${libraryName} se carg√≥ pero no est√° disponible. Verificando funci√≥n: ${checkFunction.toString()}`);
                        }
                    } catch (error) {
                        console.warn(`‚ùå Fall√≥ ${libraryName} desde: ${src} - ${error.message}`);
                        continue;
                    }
                }
                
                console.error(`‚ùå No se pudo cargar ${libraryName} desde ning√∫n CDN`);
                return false;
            }
            
            // Funci√≥n mejorada para verificar jsPDF
            function checkJsPDF() {
                // Buscar jsPDF en m√∫ltiples ubicaciones
                const locations = [
                    { name: 'window.jsPDF', value: window.jsPDF },
                    { name: 'window.jspdf', value: window.jspdf },
                    { name: 'window.JSPDF', value: window.JSPDF },
                    { name: 'global jsPDF', value: typeof jsPDF !== 'undefined' ? jsPDF : undefined },
                    { name: 'global jspdf', value: typeof jspdf !== 'undefined' ? jspdf : undefined }
                ];
                
                console.log('üîç Verificando todas las ubicaciones de jsPDF:');
                locations.forEach(loc => {
                    const type = typeof loc.value;
                    const available = type !== 'undefined';
                    console.log(`   ${available ? '‚úÖ' : '‚ùå'} ${loc.name}: ${type}${available && loc.value?.jsPDF ? ' (con constructor jsPDF)' : ''}`);
                    
                    // Si encontramos jsPDF pero no est√° en window.jsPDF, intentar copiarlo
                    if (available && !window.jsPDF) {
                        if (loc.value && (loc.value.jsPDF || typeof loc.value === 'function')) {
                            console.log(`üîÑ Intentando usar ${loc.name} como jsPDF...`);
                            try {
                                window.jsPDF = loc.value.jsPDF || loc.value;
                                console.log(`‚úÖ jsPDF asignado desde ${loc.name}`);
                            } catch (e) {
                                console.log(`‚ùå Error asignando desde ${loc.name}:`, e.message);
                            }
                        }
                    }
                });
                
                // Verificaci√≥n final
                const finalCheck = typeof window.jsPDF !== 'undefined';
                if (finalCheck) {
                    console.log('üéâ jsPDF finalmente disponible en window.jsPDF');
                    
                    // Verificar que podemos crear una instancia
                    try {
                        const testPDF = new window.jsPDF();
                        console.log('‚úÖ Test de instanciaci√≥n de jsPDF exitoso');
                        return true;
                    } catch (e) {
                        console.log('‚ùå Error creando instancia de jsPDF:', e.message);
                        return false;
                    }
                } else {
                    console.log('‚ùå jsPDF no disponible en ninguna ubicaci√≥n');
                    
                    // Como √∫ltimo recurso, intentar cargar directamente el c√≥digo
                    console.log('üîÑ Intentando √∫ltima alternativa...');
                    return false;
                }
            }
            
            // Cargar librer√≠as con fallback
            Promise.all([
                loadWithFallback(jsPDFSources, checkJsPDF, 'jsPDF'),
                loadWithFallback(html2canvasSources, () => typeof html2canvas !== 'undefined', 'html2canvas')
            ]).then((results) => {
                const jsPDFStatus = results[0];
                const html2canvasStatus = results[1];
                
                console.log('üìã Resumen de carga de librer√≠as opcionales:');
                console.log(`   jsPDF: ${jsPDFStatus ? '‚úÖ Disponible' : '‚ùå No disponible'}`);
                console.log(`   html2canvas: ${html2canvasStatus ? '‚úÖ Disponible' : '‚ùå No disponible'}`);
                
                if (!jsPDFStatus) {
                    console.log('');
                    console.log('üîÑ NOTA: jsPDF no est√° disponible, pero tienes alternativas:');
                    console.log('   1. üìÑ Exportaci√≥n HTML optimizada para impresi√≥n');
                    console.log('   2. üñºÔ∏è Exportaci√≥n de gr√°ficos individuales (funciona con html2canvas)');
                    console.log('   3. üåê Reportes HTML que se convierten a PDF con Ctrl+P');
                    console.log('');
                }
                
                // Disparar evento personalizado cuando terminen de cargar
                window.dispatchEvent(new CustomEvent('optional-libraries-loaded', { 
                    detail: { jsPDF: jsPDFStatus, html2canvas: html2canvasStatus } 
                }));
            }).catch((error) => {
                console.error('‚ùå Error en la carga de librer√≠as opcionales:', error);
                window.dispatchEvent(new CustomEvent('optional-libraries-loaded'));
            });
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            font-weight: 300;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .upload-section:hover {
            transform: translateY(-5px);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: linear-gradient(45deg, #f8f9ff, #e8ecff);
            color: #667eea;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            min-height: 100px;
        }

        .file-input-button:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #e8ecff, #dde4ff);
            transform: scale(1.02);
        }

        .file-input-button.dragover {
            border-color: #4fd1c7;
            background: linear-gradient(45deg, #e6fffa, #b2f5ea);
            color: #319795;
        }

        .upload-icon {
            font-size: 2em;
        }

        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            border-left: 4px solid #48bb78;
            display: none;
        }

        .analysis-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .column-selector {
            margin-bottom: 30px;
        }

        .column-selector h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }

        .selection-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-button {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-button:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
            transform: translateY(-1px);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .column-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .column-item input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #667eea;
        }

        .column-item label {
            font-weight: 500;
            color: #4a5568;
            cursor: pointer;
        }

        .analyze-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .analyze-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .analyze-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            display: none;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            background: #f7fafc;
            padding: 5px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            padding: 12px 15px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9em;
            text-align: center;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .stat-card h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 500;
            color: #4a5568;
        }

        .stat-value {
            color: #2d3748;
            font-weight: 600;
        }

        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 1.3em;
            font-weight: 600;
        }

        .error-message {
            background: #fed7d7;
            border: 1px solid #fc8181;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .correlation-matrix {
            overflow-x: auto;
            margin: 20px 0;
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 400px;
        }

        .correlation-table th,
        .correlation-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .correlation-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .correlation-cell {
            font-weight: 600;
            color: white;
            border-radius: 4px;
        }

        /* Estilos para gr√°ficas personalizadas */
        .custom-chart-builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 20px;
        }

        .chart-controls {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 0.95em;
        }

        .chart-select, .chart-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.3s ease;
        }

        .chart-select:focus, .chart-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .create-chart-button {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .create-chart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .create-chart-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .custom-charts-display {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }

        .no-charts-message {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
            font-style: italic;
        }

        .custom-chart-item {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .custom-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .custom-chart-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2d3748;
        }

        .delete-chart-button {
            background: #fed7d7;
            color: #c53030;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.3s ease;
        }

        .delete-chart-button:hover {
            background: #fc8181;
            color: white;
        }

        .chart-info {
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 15px;
        }

        /* Estilos para exportaci√≥n */
        .export-section {
            max-width: 1000px;
            margin: 0 auto;
        }

        .export-options {
            display: grid;
            gap: 25px;
        }

        .export-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .export-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .export-card.featured {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border: 2px solid #48bb78;
        }

        .export-card-header h4 {
            color: #2d3748;
            font-size: 1.3em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-card-header p {
            color: #718096;
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .export-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
        }

        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .export-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .export-button.primary {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 3px 12px rgba(72, 187, 120, 0.3);
        }

        .export-button.primary:hover {
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
        }

        .export-button.secondary {
            background: linear-gradient(135deg, #f7901e, #f56500);
            box-shadow: 0 3px 12px rgba(247, 144, 30, 0.3);
        }

        .export-button.secondary:hover {
            box-shadow: 0 6px 20px rgba(247, 144, 30, 0.4);
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .checkbox-option input[type="checkbox"] {
            transform: scale(1.2);
            accent-color: #48bb78;
        }

        .checkbox-option span {
            color: #2d3748;
            font-weight: 500;
        }

        .config-options {
            display: grid;
            gap: 15px;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95em;
        }

        .config-input, .config-select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.3s ease;
        }

        .config-input:focus, .config-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .individual-charts {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .chart-export-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-bottom: 8px;
        }

        .chart-export-name {
            font-weight: 500;
            color: #2d3748;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            color: #2d3748;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .column-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .selection-controls {
                justify-content: center;
            }

            .control-button {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }

            .custom-chart-builder {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .chart-controls {
                order: 1;
            }

            .custom-charts-display {
                order: 2;
            }

            .tab-buttons {
                flex-wrap: wrap;
            }

            .tab-button {
                flex: 1 1 auto;
                min-width: 80px;
                font-size: 0.8em;
                padding: 8px 6px;
            }

            .export-buttons {
                flex-direction: column;
            }

            .export-button {
                width: 100%;
                text-align: center;
            }

            .report-options {
                grid-template-columns: 1fr;
            }

            .config-group {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingTitle">Generando reporte...</h3>
            <p id="loadingMessage">Por favor, espera mientras procesamos tu an√°lisis</p>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>üîç Analizador EDA-SimpleX</h1>
            <p class="subtitle">An√°lisis Exploratorio de Datos para archivos CSV</p>
        </header>

        <div class="error-message" id="errorMessage"></div>

        <section class="upload-section">
            <h2>üìÅ Cargar archivo CSV</h2>
            <p style="margin-bottom: 20px; color: #4a5568;">
                Sube tu archivo CSV (m√°ximo 20MB). Debe tener encabezados en la primera fila, separaci√≥n por comas y codificaci√≥n UTF-8.
            </p>
            
            <div class="file-input-wrapper">
                <input type="file" class="file-input" id="csvFile" accept=".csv" />
                <label for="csvFile" class="file-input-button" id="fileInputButton">
                    <span class="upload-icon">üì§</span>
                    <span>Haz clic aqu√≠ o arrastra tu archivo CSV</span>
                </label>
            </div>
            
            <div class="file-info" id="fileInfo"></div>
        </section>

        <section class="analysis-section" id="analysisSection">
            <div class="column-selector">
                <h3>üìä Selecciona las columnas a analizar</h3>
                <div class="selection-controls" style="margin-bottom: 15px;">
                    <button class="control-button" id="selectAllButton">‚úÖ Seleccionar todas</button>
                    <button class="control-button" id="deselectAllButton">‚ùå Deseleccionar todas</button>
                    <button class="control-button" id="selectNumericButton">üî¢ Solo num√©ricas</button>
                </div>
                <div class="column-grid" id="columnGrid"></div>
                <button class="analyze-button" id="analyzeButton" disabled>
                    Iniciar An√°lisis EDA
                </button>
            </div>
        </section>

        <section class="results-section" id="resultsSection">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="overview">üìã Resumen</button>
                    <button class="tab-button" data-tab="statistics">üìà Estad√≠sticas</button>
                    <button class="tab-button" data-tab="visualizations">üìä Visualizaciones</button>
                    <button class="tab-button" data-tab="custom-charts">üé® Gr√°ficas</button>
                    <button class="tab-button" data-tab="correlations">üîó Correlaciones</button>
                    <button class="tab-button" data-tab="quality">üîç Calidad</button>
                    <button class="tab-button" data-tab="export">üìÑ Exportar</button>
                </div>

                <div class="tab-content active" id="overview">
                    <h3>Resumen General del Dataset</h3>
                    <div id="overviewContent"></div>
                </div>

                <div class="tab-content" id="statistics">
                    <h3>Estad√≠sticas Descriptivas</h3>
                    <div id="statisticsContent"></div>
                </div>

                <div class="tab-content" id="visualizations">
                    <h3>Visualizaciones</h3>
                    <div id="visualizationsContent"></div>
                </div>

                <div class="tab-content" id="custom-charts">
                    <h3>üé® Crear Gr√°ficas Personalizadas</h3>
                    <div class="custom-chart-builder">
                        <div class="chart-controls">
                            <div class="control-group">
                                <label for="chartType"><strong>üìä Tipo de Gr√°fica:</strong></label>
                                <select id="chartType" class="chart-select">
                                    <option value="scatter">üîµ Scatter Plot (Dispersi√≥n)</option>
                                    <option value="histogram">üìä Histograma</option>
                                    <option value="pie">ü•ß Gr√°fico de Pie</option>
                                    <option value="bar">üìà Gr√°fico de Barras</option>
                                    <option value="line">üìâ Gr√°fico de L√≠neas</option>
                                </select>
                            </div>

                            <div class="control-group" id="xAxisGroup">
                                <label for="xAxisVariable"><strong>üìê Variable X (Eje Horizontal):</strong></label>
                                <select id="xAxisVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group" id="yAxisGroup">
                                <label for="yAxisVariable"><strong>üìè Variable Y (Eje Vertical):</strong></label>
                                <select id="yAxisVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group" id="categoryGroup" style="display: none;">
                                <label for="categoryVariable"><strong>üè∑Ô∏è Variable de Categor√≠a:</strong></label>
                                <select id="categoryVariable" class="chart-select">
                                    <option value="">Selecciona una variable...</option>
                                </select>
                            </div>

                            <div class="control-group">
                                <label for="chartTitle"><strong>üìù T√≠tulo de la Gr√°fica:</strong></label>
                                <input type="text" id="chartTitle" class="chart-input" placeholder="Mi gr√°fica personalizada" />
                            </div>

                            <button class="create-chart-button" id="createCustomChart">
                                ‚ú® Crear Gr√°fica
                            </button>
                        </div>

                        <div id="customChartsContainer" class="custom-charts-display">
                            <div class="no-charts-message">
                                <p>üéØ Crea tu primera gr√°fica personalizada seleccionando el tipo y las variables!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="correlations">
                    <h3>Matriz de Correlaciones</h3>
                    <div id="correlationsContent"></div>
                </div>

                <div class="tab-content" id="quality">
                    <h3>An√°lisis de Calidad de Datos</h3>
                    <div id="qualityContent"></div>
                </div>

                <div class="tab-content" id="export">
                    <h3>üìÑ Exportar An√°lisis</h3>
                    <div class="export-section">
                        <div class="export-options">
                            <div class="export-card">
                                <div class="export-card-header">
                                    <h4>üìä Exportar Datos</h4>
                                    <p>Descarga los datos analizados en diferentes formatos</p>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button" id="exportFilteredCSV">
                                        üíæ Datos Filtrados (CSV)
                                    </button>
                                    <button class="export-button" id="exportStatistics">
                                        üìà Estad√≠sticas (CSV)
                                    </button>
                                    <button class="export-button" id="exportCorrelations">
                                        üîó Correlaciones (CSV)
                                    </button>
                                </div>
                            </div>

                            <div class="export-card">
                                <div class="export-card-header">
                                    <h4>üñºÔ∏è Exportar Gr√°ficos</h4>
                                    <p>Descarga visualizaciones individuales</p>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button" id="exportAllCharts">
                                        üé® Todos los Gr√°ficos (ZIP)
                                    </button>
                                    <button class="export-button" id="exportCustomCharts">
                                        ‚ú® Gr√°ficos Personalizados (ZIP)
                                    </button>
                                </div>
                                <div class="individual-charts" id="individualChartsExport">
                                    <p><em>Los gr√°ficos individuales aparecer√°n aqu√≠ despu√©s del an√°lisis</em></p>
                                </div>
                            </div>

                            <div class="export-card featured">
                                <div class="export-card-header">
                                    <h4>üìã Generar Reporte Completo</h4>
                                    <p>Crea un reporte profesional con todos los an√°lisis</p>
                                </div>
                                <div class="report-options">
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeOverview" checked>
                                        <span>üìä Incluir Resumen General</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeStatistics" checked>
                                        <span>üìà Incluir Estad√≠sticas Descriptivas</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeVisualizations" checked>
                                        <span>üìä Incluir Visualizaciones Autom√°ticas</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeCustomCharts" checked>
                                        <span>üé® Incluir Gr√°ficos Personalizados</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeCorrelations" checked>
                                        <span>üîó Incluir Matrix de Correlaciones</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="includeQuality" checked>
                                        <span>üîç Incluir An√°lisis de Calidad</span>
                                    </label>
                                </div>
                                <div class="export-buttons">
                                    <button class="export-button primary" id="generateHTMLReport">
                                        üåê Generar Reporte HTML
                                    </button>
                                    <button class="export-button primary" id="generatePDFReport">
                                        üìë Generar Reporte PDF
                                    </button>
                                </div>
                            </div>

                            <div class="export-card">
                                <div class="export-card-header">
                                    <h4>‚öôÔ∏è Configuraci√≥n Avanzada</h4>
                                    <p>Personaliza tus exportaciones</p>
                                </div>
                                <div class="config-options">
                                    <div class="config-group">
                                        <label for="reportTitle">üìù T√≠tulo del Reporte:</label>
                                        <input type="text" id="reportTitle" class="config-input" placeholder="An√°lisis EDA - Mi Dataset" />
                                    </div>
                                    <div class="config-group">
                                        <label for="authorName">üë§ Autor:</label>
                                        <input type="text" id="authorName" class="config-input" placeholder="Tu nombre" />
                                    </div>
                                    <div class="config-group">
                                        <label for="imageQuality">üñºÔ∏è Calidad de Im√°genes:</label>
                                        <select id="imageQuality" class="config-select">
                                            <option value="0.8">Alta (0.8)</option>
                                            <option value="1.0" selected>M√°xima (1.0)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Verificar que todas las librer√≠as est√©n cargadas
        document.addEventListener('DOMContentLoaded', function() {
            // Funci√≥n para verificar carga de librer√≠as con reintentos
            function checkLibrariesAndInit(retries = 5) {
                const libraries = [
                    { name: 'PapaParse', check: () => typeof Papa !== 'undefined', required: true },
                    { name: 'Chart.js', check: () => typeof Chart !== 'undefined', required: true },
                    { name: 'Lodash', check: () => typeof _ !== 'undefined', required: true },
                    { name: 'jsPDF', check: () => typeof window.jsPDF !== 'undefined', required: false },
                    { name: 'html2canvas', check: () => typeof html2canvas !== 'undefined', required: false }
                ];

                const missingRequired = libraries.filter(lib => lib.required && !lib.check());
                const missingOptional = libraries.filter(lib => !lib.required && !lib.check());

                if (missingRequired.length > 0) {
                    if (retries > 0) {
                        console.log(`Esperando librer√≠as requeridas... Reintentos: ${retries}`);
                        setTimeout(() => checkLibrariesAndInit(retries - 1), 1000);
                        return;
                    } else {
                        const errorMsg = `Error: Librer√≠as requeridas no disponibles: ${missingRequired.map(l => l.name).join(', ')}`;
                        console.error(errorMsg);
                        document.body.innerHTML = `
                            <div style="text-align: center; padding: 50px; color: red;">
                                <h2>${errorMsg}</h2>
                                <p>Por favor, recarga la p√°gina o verifica tu conexi√≥n a internet</p>
                                <button onclick="location.reload()" style="padding: 10px 20px; font-size: 16px; margin-top: 20px;">
                                    Recargar P√°gina
                                </button>
                            </div>
                        `;
                        return;
                    }
                }

                // Mostrar advertencias para librer√≠as opcionales faltantes
                if (missingOptional.length > 0) {
                    const warnings = missingOptional.map(lib => {
                        if (lib.name === 'jsPDF') {
                            return 'jsPDF no est√° disponible - la exportaci√≥n a PDF estar√° limitada';
                        } else if (lib.name === 'html2canvas') {
                            return 'html2canvas no est√° disponible - algunas funciones avanzadas pueden no funcionar';
                        }
                        return `${lib.name} no est√° disponible`;
                    });
                    
                    warnings.forEach(warning => console.warn(warning));
                }

                // Todas las librer√≠as requeridas est√°n disponibles
                console.log('‚úÖ Todas las librer√≠as requeridas cargadas correctamente');
                
                // Mostrar estado de librer√≠as opcionales
                const optionalLoaded = libraries.filter(lib => !lib.required && lib.check());
                if (optionalLoaded.length > 0) {
                    console.log(`‚úÖ Librer√≠as opcionales cargadas: ${optionalLoaded.map(l => l.name).join(', ')}`);
                }
                
                // Inicializar aplicaci√≥n
                initializeApp();

                // Si faltan librer√≠as opcionales, mostrar notificaci√≥n
                if (missingOptional.some(lib => lib.name === 'jsPDF')) {
                    showOptionalLibraryNotification();
                }
            }

            // Escuchar evento de librer√≠as opcionales cargadas
            window.addEventListener('optional-libraries-loaded', function() {
                console.log('üîÑ Librer√≠as opcionales terminaron de cargar, verificando nuevamente...');
                setTimeout(() => {
                    // Re-verificar y actualizar interfaz si es necesario
                    const jsPDFNowAvailable = typeof window.jsPDF !== 'undefined';
                    const html2canvasNowAvailable = typeof html2canvas !== 'undefined';
                    
                    if (jsPDFNowAvailable) {
                        console.log('‚úÖ jsPDF ahora disponible');
                        // Actualizar bot√≥n PDF si ya se inicializ√≥ la app
                        const pdfButton = document.getElementById('generatePDFReport');
                        if (pdfButton) {
                            pdfButton.disabled = false;
                            pdfButton.style.opacity = '1';
                            pdfButton.innerHTML = 'üìë Generar Reporte PDF';
                            pdfButton.title = 'Generar un reporte PDF profesional con gr√°ficos integrados';
                            
                            // Remover advertencia si existe
                            const warning = document.querySelector('.pdf-warning');
                            if (warning) warning.remove();
                            
                            // Remover notificaci√≥n si existe
                            const notification = document.querySelector('.optional-library-notification');
                            if (notification) notification.remove();
                        }
                    }
                    
                    if (html2canvasNowAvailable) {
                        console.log('‚úÖ html2canvas ahora disponible');
                    }
                }, 200);
            });

            // Iniciar verificaci√≥n
            checkLibrariesAndInit();
        });

        function showOptionalLibraryNotification() {
            setTimeout(() => {
                // Verificar si ya se carg√≥ mientras tanto
                if (typeof window.jsPDF !== 'undefined') return;
                
                const notification = document.createElement('div');
                notification.className = 'optional-library-notification';
                notification.style.cssText = `
                    position: fixed; top: 10px; right: 10px; z-index: 10000;
                    background: #fed7d7; color: #c53030; padding: 15px 20px;
                    border-radius: 8px; border: 1px solid #fc8181;
                    max-width: 350px; font-family: inherit;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    animation: slideIn 0.3s ease-out;
                `;
                
                notification.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong>‚ö†Ô∏è Librer√≠as PDF no disponibles</strong><br>
                            <small>Intentando cargar desde CDNs alternativos...</small><br>
                            <em>Alternativa: Exportaci√≥n HTML ‚Üí Imprimir como PDF</em>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: none; border: none; color: #c53030; font-size: 18px; cursor: pointer; margin-left: 10px;">√ó</button>
                    </div>
                `;
                
                // Agregar animaci√≥n CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(notification);
                
                // Auto-remover despu√©s de 10 segundos
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.style.animation = 'slideIn 0.3s ease-out reverse';
                        setTimeout(() => notification.remove(), 300);
                    }
                }, 10000);
            }, 2000);
        }

        let csvData = null;
        let selectedColumns = [];
        let dataTypes = {};
        let customChartCounter = 0;
        let analysisData = null;

        // Elementos del DOM
        const csvFileInput = document.getElementById('csvFile');
        const fileInputButton = document.getElementById('fileInputButton');
        const fileInfo = document.getElementById('fileInfo');
        const analysisSection = document.getElementById('analysisSection');
        const columnGrid = document.getElementById('columnGrid');
        const analyzeButton = document.getElementById('analyzeButton');
        const selectAllButton = document.getElementById('selectAllButton');
        const deselectAllButton = document.getElementById('deselectAllButton');
        const selectNumericButton = document.getElementById('selectNumericButton');
        const resultsSection = document.getElementById('resultsSection');
        const errorMessage = document.getElementById('errorMessage');

        // Elementos para gr√°ficas personalizadas
        const chartType = document.getElementById('chartType');
        const xAxisVariable = document.getElementById('xAxisVariable');
        const yAxisVariable = document.getElementById('yAxisVariable');
        const categoryVariable = document.getElementById('categoryVariable');
        const chartTitle = document.getElementById('chartTitle');
        const createCustomChart = document.getElementById('createCustomChart');
        const customChartsContainer = document.getElementById('customChartsContainer');

        // Elementos para exportaci√≥n
        const exportFilteredCSV = document.getElementById('exportFilteredCSV');
        const exportStatistics = document.getElementById('exportStatistics');
        const exportCorrelations = document.getElementById('exportCorrelations');
        const exportAllCharts = document.getElementById('exportAllCharts');
        const exportCustomCharts = document.getElementById('exportCustomCharts');
        const generateHTMLReport = document.getElementById('generateHTMLReport');
        const generatePDFReport = document.getElementById('generatePDFReport');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const individualChartsExport = document.getElementById('individualChartsExport');

        function initializeApp() {
            // Event listeners
            csvFileInput.addEventListener('change', handleFileSelect);
            analyzeButton.addEventListener('click', performAnalysis);
            selectAllButton.addEventListener('click', selectAllColumns);
            deselectAllButton.addEventListener('click', deselectAllColumns);
            selectNumericButton.addEventListener('click', selectNumericColumns);

            // Event listeners para gr√°ficas personalizadas
            chartType.addEventListener('change', updateChartControls);
            createCustomChart.addEventListener('click', createCustomChartFunction);

            // Event listeners para exportaci√≥n
            exportFilteredCSV.addEventListener('click', () => exportData('filtered'));
            exportStatistics.addEventListener('click', () => exportData('statistics'));
            exportCorrelations.addEventListener('click', () => exportData('correlations'));
            exportAllCharts.addEventListener('click', () => exportCharts('all'));
            exportCustomCharts.addEventListener('click', () => exportCharts('custom'));
            generateHTMLReport.addEventListener('click', () => generateReport('html'));
            generatePDFReport.addEventListener('click', () => generateReport('pdf'));

            // Drag and drop
            fileInputButton.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileInputButton.classList.add('dragover');
            });

            fileInputButton.addEventListener('dragleave', () => {
                fileInputButton.classList.remove('dragover');
            });

            fileInputButton.addEventListener('drop', (e) => {
                e.preventDefault();
                fileInputButton.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    csvFileInput.files = files;
                    handleFileSelect();
                }
            });

            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showLoading(show, title = 'Generando reporte...', message = 'Por favor, espera mientras procesamos tu an√°lisis') {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            if (show) {
                document.getElementById('loadingTitle').textContent = title;
                document.getElementById('loadingMessage').textContent = message;
            }
        }

        function handleFileSelect() {
            const file = csvFileInput.files[0];
            if (!file) return;

            // Validaciones
            if (file.size > 20 * 1024 * 1024) { // 20MB
                showError('El archivo es demasiado grande. El l√≠mite es de 20MB.');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showError('Por favor, selecciona un archivo CSV v√°lido.');
                return;
            }

            // Mostrar informaci√≥n del archivo
            fileInfo.innerHTML = `
                <strong>üìÑ Archivo seleccionado:</strong> ${file.name}<br>
                <strong>üìè Tama√±o:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                <strong>üïí √öltima modificaci√≥n:</strong> ${new Date(file.lastModified).toLocaleString('es-ES')}
            `;
            fileInfo.style.display = 'block';

            // Leer y parsear el archivo
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const results = Papa.parse(e.target.result, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.trim(),
                        dynamicTyping: true
                    });

                    if (results.errors.length > 0) {
                        showError('Error al procesar el CSV: ' + results.errors[0].message);
                        return;
                    }

                    csvData = results.data;
                    setupColumnSelector();
                    analysisSection.style.display = 'block';
                    
                } catch (error) {
                    showError('Error al leer el archivo: ' + error.message);
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function setupColumnSelector() {
            if (!csvData || csvData.length === 0) return;

            const headers = Object.keys(csvData[0]);
            columnGrid.innerHTML = '';

            // Detectar tipos de datos
            dataTypes = {};
            headers.forEach(header => {
                const sample = csvData.slice(0, 100).map(row => row[header]).filter(val => val !== null && val !== undefined && val !== '');
                if (sample.length === 0) {
                    dataTypes[header] = 'empty';
                } else if (sample.every(val => !isNaN(val) && isFinite(val))) {
                    dataTypes[header] = 'numeric';
                } else if (sample.every(val => !isNaN(Date.parse(val)))) {
                    dataTypes[header] = 'datetime';
                } else {
                    dataTypes[header] = 'categorical';
                }
            });

            headers.forEach((header, index) => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col-${index}`;
                checkbox.value = header;
                checkbox.checked = dataTypes[header] === 'numeric'; // Seleccionar num√©ricas por defecto
                
                const label = document.createElement('label');
                label.htmlFor = `col-${index}`;
                label.innerHTML = `${header} <small style="color: #718096;">(${dataTypes[header]})</small>`;
                
                checkbox.addEventListener('change', updateSelectedColumns);
                
                columnItem.appendChild(checkbox);
                columnItem.appendChild(label);
                columnGrid.appendChild(columnItem);
            });

            updateSelectedColumns();
        }

        function updateSelectedColumns() {
            selectedColumns = Array.from(document.querySelectorAll('.column-item input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            analyzeButton.disabled = selectedColumns.length === 0;
        }

        function selectAllColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedColumns();
        }

        function deselectAllColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedColumns();
        }

        function selectNumericColumns() {
            document.querySelectorAll('.column-item input[type="checkbox"]').forEach(checkbox => {
                const columnName = checkbox.value;
                checkbox.checked = dataTypes[columnName] === 'numeric';
            });
            updateSelectedColumns();
        }

        function performAnalysis() {
            if (selectedColumns.length === 0) {
                showError('Selecciona al menos una columna para analizar.');
                return;
            }

            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });

            // Filtrar datos por columnas seleccionadas
            const filteredData = csvData.map(row => {
                const filteredRow = {};
                selectedColumns.forEach(col => {
                    filteredRow[col] = row[col];
                });
                return filteredRow;
            });

            // Generar an√°lisis
            generateOverview(filteredData);
            generateStatistics(filteredData);
            generateVisualizations(filteredData);
            generateCorrelations(filteredData);
            generateQualityAnalysis(filteredData);
            
            // Poblar las variables para gr√°ficas personalizadas
            populateCustomChartVariables();
            
            // Almacenar datos para exportaci√≥n
            analysisData = {
                original: csvData,
                filtered: filteredData,
                columns: selectedColumns,
                types: dataTypes
            };
            
            // Preparar opciones de exportaci√≥n
            prepareExportOptions();
        }

        function generateOverview(data) {
            const totalRows = data.length;
            const totalColumns = selectedColumns.length;
            const numericColumns = selectedColumns.filter(col => dataTypes[col] === 'numeric').length;
            const categoricalColumns = selectedColumns.filter(col => dataTypes[col] === 'categorical').length;

            let memoryUsage = 0;
            selectedColumns.forEach(col => {
                const values = data.map(row => row[col]).filter(val => val !== null && val !== undefined);
                memoryUsage += values.length * (dataTypes[col] === 'numeric' ? 8 : 50); // Estimaci√≥n
            });

            document.getElementById('overviewContent').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>üìä Informaci√≥n General</h4>
                        <div class="stat-item"><span class="stat-label">Total de filas:</span><span class="stat-value">${totalRows.toLocaleString()}</span></div>
                        <div class="stat-item"><span class="stat-label">Total de columnas analizadas:</span><span class="stat-value">${totalColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Columnas num√©ricas:</span><span class="stat-value">${numericColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Columnas categ√≥ricas:</span><span class="stat-value">${categoricalColumns}</span></div>
                        <div class="stat-item"><span class="stat-label">Uso estimado de memoria:</span><span class="stat-value">${(memoryUsage / 1024 / 1024).toFixed(2)} MB</span></div>
                    </div>
                </div>
            `;
        }

        function generateStatistics(data) {
            const statsContent = document.getElementById('statisticsContent');
            statsContent.innerHTML = '<div class="loading">Generando estad√≠sticas...</div>';

            setTimeout(() => {
                let html = '<div class="stats-grid">';

                selectedColumns.forEach(column => {
                    const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && val !== '');
                    
                    if (dataTypes[column] === 'numeric') {
                        const numericValues = values.map(Number).filter(val => !isNaN(val));
                        if (numericValues.length > 0) {
                            const sorted = numericValues.sort((a, b) => a - b);
                            const stats = {
                                count: numericValues.length,
                                mean: _.mean(numericValues),
                                median: sorted[Math.floor(sorted.length / 2)],
                                std: Math.sqrt(_.mean(numericValues.map(x => Math.pow(x - _.mean(numericValues), 2)))),
                                min: _.min(numericValues),
                                max: _.max(numericValues),
                                q1: sorted[Math.floor(sorted.length * 0.25)],
                                q3: sorted[Math.floor(sorted.length * 0.75)]
                            };

                            html += `
                                <div class="stat-card">
                                    <h4>${column}</h4>
                                    <div class="stat-item"><span class="stat-label">Cantidad:</span><span class="stat-value">${stats.count}</span></div>
                                    <div class="stat-item"><span class="stat-label">Media:</span><span class="stat-value">${stats.mean.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Mediana:</span><span class="stat-value">${stats.median.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Desv. Est√°ndar:</span><span class="stat-value">${stats.std.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">M√≠nimo:</span><span class="stat-value">${stats.min}</span></div>
                                    <div class="stat-item"><span class="stat-label">M√°ximo:</span><span class="stat-value">${stats.max}</span></div>
                                    <div class="stat-item"><span class="stat-label">Q1 (25%):</span><span class="stat-value">${stats.q1.toFixed(2)}</span></div>
                                    <div class="stat-item"><span class="stat-label">Q3 (75%):</span><span class="stat-value">${stats.q3.toFixed(2)}</span></div>
                                </div>
                            `;
                        }
                    } else {
                        const counts = _.countBy(values);
                        const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                        const topValues = sortedCounts.slice(0, 5);

                        html += `
                            <div class="stat-card">
                                <h4>${column} (Categ√≥rica)</h4>
                                <div class="stat-item"><span class="stat-label">Valores √∫nicos:</span><span class="stat-value">${Object.keys(counts).length}</span></div>
                                <div class="stat-item"><span class="stat-label">Valor m√°s frecuente:</span><span class="stat-value">${sortedCounts[0][0]} (${sortedCounts[0][1]})</span></div>
                                <div style="margin-top: 10px;"><strong>Top 5 valores:</strong></div>
                                ${topValues.map(([value, count]) => 
                                    `<div class="stat-item"><span class="stat-label">${value}:</span><span class="stat-value">${count}</span></div>`
                                ).join('')}
                            </div>
                        `;
                    }
                });

                html += '</div>';
                statsContent.innerHTML = html;
            }, 100);
        }

        function generateVisualizations(data) {
            const vizContent = document.getElementById('visualizationsContent');
            vizContent.innerHTML = '<div class="loading">Generando visualizaciones...</div>';

            setTimeout(() => {
                let html = '';
                let chartIndex = 0;

                selectedColumns.forEach(column => {
                    if (dataTypes[column] === 'numeric') {
                        const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && !isNaN(val));
                        
                        if (values.length > 0) {
                            // Histograma
                            const chartId = `chart-${chartIndex++}`;
                            html += `
                                <div class="chart-container">
                                    <div class="chart-title">üìä Histograma - ${column}</div>
                                    <canvas id="${chartId}" width="400" height="200"></canvas>
                                </div>
                            `;

                            setTimeout(() => {
                                const ctx = document.getElementById(chartId);
                                if (ctx) {
                                    createHistogram(ctx, values, column);
                                }
                            }, 100);
                        }
                    } else {
                        // Gr√°fico de barras para categ√≥ricas
                        const values = data.map(row => row[column]).filter(val => val !== null && val !== undefined && val !== '');
                        const counts = _.countBy(values);
                        const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);

                        if (sortedCounts.length > 0) {
                            const chartId = `chart-${chartIndex++}`;
                            html += `
                                <div class="chart-container">
                                    <div class="chart-title">üìà Distribuci√≥n - ${column}</div>
                                    <canvas id="${chartId}" width="400" height="200"></canvas>
                                </div>
                            `;

                            setTimeout(() => {
                                const ctx = document.getElementById(chartId);
                                if (ctx) {
                                    createBarChart(ctx, sortedCounts, column);
                                }
                            }, 100);
                        }
                    }
                });

                vizContent.innerHTML = html;
            }, 100);
        }

        function createHistogram(ctx, values, title) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible');
                ctx.parentElement.innerHTML = '<p style="color: red;">Error: Chart.js no se pudo cargar</p>';
                return;
            }

            const min = Math.min(...values);
            const max = Math.max(...values);
            const bins = 15;
            const binWidth = (max - min) / bins;
            
            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = min + (i + 1) * binWidth;
                labels.push(`${binStart.toFixed(1)}-${binEnd.toFixed(1)}`);
                
                histogram[i] = values.filter(val => val >= binStart && (i === bins - 1 ? val <= binEnd : val < binEnd)).length;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: histogram,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: title
                            }
                        }
                    }
                }
            });
        }

        function createBarChart(ctx, data, title) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible');
                ctx.parentElement.innerHTML = '<p style="color: red;">Error: Chart.js no se pudo cargar</p>';
                return;
            }

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(item => item[0]),
                    datasets: [{
                        label: 'Frecuencia',
                        data: data.map(item => item[1]),
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia'
                            }
                        }
                    }
                }
            });
        }

        function generateCorrelations(data) {
            const corrContent = document.getElementById('correlationsContent');
            const numericColumns = selectedColumns.filter(col => dataTypes[col] === 'numeric');

            if (numericColumns.length < 2) {
                corrContent.innerHTML = '<p>Se necesitan al menos 2 columnas num√©ricas para calcular correlaciones.</p>';
                return;
            }

            corrContent.innerHTML = '<div class="loading">Calculando correlaciones...</div>';

            setTimeout(() => {
                const correlationMatrix = calculateCorrelationMatrix(data, numericColumns);
                
                let html = `
                    <div class="correlation-matrix">
                        <table class="correlation-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    ${numericColumns.map(col => `<th>${col}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                numericColumns.forEach((row, i) => {
                    html += `<tr><th>${row}</th>`;
                    numericColumns.forEach((col, j) => {
                        const corr = correlationMatrix[i][j];
                        const intensity = Math.abs(corr);
                        const color = corr > 0 ? 
                            `rgba(72, 187, 120, ${intensity})` : 
                            `rgba(245, 101, 101, ${intensity})`;
                        
                        html += `<td class="correlation-cell" style="background-color: ${color}">
                            ${corr.toFixed(3)}
                        </td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table></div>';
                corrContent.innerHTML = html;
            }, 100);
        }

        function calculateCorrelationMatrix(data, columns) {
            const matrix = [];
            
            for (let i = 0; i < columns.length; i++) {
                matrix[i] = [];
                for (let j = 0; j < columns.length; j++) {
                    if (i === j) {
                        matrix[i][j] = 1;
                    } else {
                        const values1 = data.map(row => Number(row[columns[i]])).filter(val => !isNaN(val));
                        const values2 = data.map(row => Number(row[columns[j]])).filter(val => !isNaN(val));
                        matrix[i][j] = calculateCorrelation(values1, values2);
                    }
                }
            }
            return matrix;
        }

        function calculateCorrelation(x, y) {
            const n = Math.min(x.length, y.length);
            if (n < 2) return 0;

            const meanX = _.mean(x.slice(0, n));
            const meanY = _.mean(y.slice(0, n));

            let numerator = 0;
            let sumSqX = 0;
            let sumSqY = 0;

            for (let i = 0; i < n; i++) {
                const diffX = x[i] - meanX;
                const diffY = y[i] - meanY;
                numerator += diffX * diffY;
                sumSqX += diffX * diffX;
                sumSqY += diffY * diffY;
            }

            const denominator = Math.sqrt(sumSqX * sumSqY);
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function generateQualityAnalysis(data) {
            const qualityContent = document.getElementById('qualityContent');
            qualityContent.innerHTML = '<div class="loading">Analizando calidad de datos...</div>';

            setTimeout(() => {
                let html = '<div class="stats-grid">';

                selectedColumns.forEach(column => {
                    const totalRows = data.length;
                    const values = data.map(row => row[column]);
                    const nullValues = values.filter(val => val === null || val === undefined || val === '').length;
                    const validValues = totalRows - nullValues;
                    const uniqueValues = new Set(values.filter(val => val !== null && val !== undefined && val !== '')).size;

                    let outliers = 0;
                    if (dataTypes[column] === 'numeric') {
                        const numericValues = values.map(Number).filter(val => !isNaN(val));
                        if (numericValues.length > 0) {
                            const sorted = numericValues.sort((a, b) => a - b);
                            const q1 = sorted[Math.floor(sorted.length * 0.25)];
                            const q3 = sorted[Math.floor(sorted.length * 0.75)];
                            const iqr = q3 - q1;
                            const lowerBound = q1 - 1.5 * iqr;
                            const upperBound = q3 + 1.5 * iqr;
                            outliers = numericValues.filter(val => val < lowerBound || val > upperBound).length;
                        }
                    }

                    html += `
                        <div class="stat-card">
                            <h4>${column}</h4>
                            <div class="stat-item">
                                <span class="stat-label">Valores v√°lidos:</span>
                                <span class="stat-value">${validValues} (${(validValues/totalRows*100).toFixed(1)}%)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valores faltantes:</span>
                                <span class="stat-value">${nullValues} (${(nullValues/totalRows*100).toFixed(1)}%)</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Valores √∫nicos:</span>
                                <span class="stat-value">${uniqueValues}</span>
                            </div>
                            ${dataTypes[column] === 'numeric' ? `
                                <div class="stat-item">
                                    <span class="stat-label">Outliers detectados:</span>
                                    <span class="stat-value">${outliers} (${(outliers/totalRows*100).toFixed(1)}%)</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                qualityContent.innerHTML = html;
            }, 100);
        }

        // Funciones para gr√°ficas personalizadas
        function populateCustomChartVariables() {
            // Limpiar opciones anteriores
            [xAxisVariable, yAxisVariable, categoryVariable].forEach(select => {
                select.innerHTML = '<option value="">Selecciona una variable...</option>';
            });

            // Poblar con las columnas seleccionadas
            selectedColumns.forEach(column => {
                const option1 = new Option(column, column);
                const option2 = new Option(column, column);
                const option3 = new Option(column, column);
                
                xAxisVariable.add(option1);
                yAxisVariable.add(option2);
                categoryVariable.add(option3);
            });

            updateChartControls();
        }

        function updateChartControls() {
            const selectedType = chartType.value;
            const xAxisGroup = document.getElementById('xAxisGroup');
            const yAxisGroup = document.getElementById('yAxisGroup');
            const categoryGroup = document.getElementById('categoryGroup');

            // Reset visibility
            xAxisGroup.style.display = 'block';
            yAxisGroup.style.display = 'block';
            categoryGroup.style.display = 'none';

            // Actualizar controles seg√∫n el tipo de gr√°fica
            switch(selectedType) {
                case 'histogram':
                    yAxisGroup.style.display = 'none';
                    xAxisGroup.querySelector('label').innerHTML = '<strong>üìä Variable para Histograma:</strong>';
                    break;
                case 'pie':
                    xAxisGroup.style.display = 'none';
                    yAxisGroup.style.display = 'none';
                    categoryGroup.style.display = 'block';
                    break;
                case 'scatter':
                    xAxisGroup.querySelector('label').innerHTML = '<strong>üìê Variable X (Eje Horizontal):</strong>';
                    yAxisGroup.querySelector('label').innerHTML = '<strong>üìè Variable Y (Eje Vertical):</strong>';
                    break;
                case 'bar':
                case 'line':
                    xAxisGroup.querySelector('label').innerHTML = '<strong>üìê Variable X (Categor√≠as/Tiempo):</strong>';
                    yAxisGroup.querySelector('label').innerHTML = '<strong>üìè Variable Y (Valores):</strong>';
                    break;
            }
        }

        function createCustomChartFunction() {
            const selectedType = chartType.value;
            const xVar = xAxisVariable.value;
            const yVar = yAxisVariable.value;
            const categoryVar = categoryVariable.value;
            const title = chartTitle.value || `Gr√°fica ${selectedType}`;

            // Validaciones
            if (selectedType === 'histogram' && !xVar) {
                showError('Selecciona una variable para el histograma.');
                return;
            }
            if (selectedType === 'pie' && !categoryVar) {
                showError('Selecciona una variable de categor√≠a para el gr√°fico de pie.');
                return;
            }
            if ((selectedType === 'scatter' || selectedType === 'bar' || selectedType === 'line') && (!xVar || !yVar)) {
                showError('Selecciona ambas variables X e Y para este tipo de gr√°fica.');
                return;
            }

            // Crear la gr√°fica
            const chartId = `custom-chart-${customChartCounter++}`;
            createCustomChartElement(chartId, title, selectedType, xVar, yVar, categoryVar);
        }

        function createCustomChartElement(chartId, title, type, xVar, yVar, categoryVar) {
            // Remover mensaje de "no hay gr√°ficas" si existe
            const noChartsMessage = customChartsContainer.querySelector('.no-charts-message');
            if (noChartsMessage) {
                noChartsMessage.remove();
            }

            // Crear el contenedor de la gr√°fica
            const chartContainer = document.createElement('div');
            chartContainer.className = 'custom-chart-item';
            chartContainer.innerHTML = `
                <div class="custom-chart-header">
                    <div class="custom-chart-title">${title}</div>
                    <button class="delete-chart-button" onclick="deleteCustomChart(this)">üóëÔ∏è Eliminar</button>
                </div>
                <div class="chart-info">
                    Tipo: ${getChartTypeLabel(type)} | 
                    Variables: ${getVariablesInfo(type, xVar, yVar, categoryVar)}
                </div>
                <canvas id="${chartId}" width="400" height="200"></canvas>
            `;

            customChartsContainer.appendChild(chartContainer);

            // Generar la gr√°fica
            setTimeout(() => {
                const canvas = document.getElementById(chartId);
                if (canvas) {
                    generateCustomChart(canvas, type, xVar, yVar, categoryVar, title);
                }
            }, 100);

            // Actualizar lista de exportaci√≥n
            setTimeout(() => {
                updateIndividualChartsExport();
            }, 200);
        }

        function getChartTypeLabel(type) {
            const labels = {
                'scatter': 'üîµ Scatter Plot',
                'histogram': 'üìä Histograma', 
                'pie': 'ü•ß Gr√°fico de Pie',
                'bar': 'üìà Gr√°fico de Barras',
                'line': 'üìâ Gr√°fico de L√≠neas'
            };
            return labels[type] || type;
        }

        function getVariablesInfo(type, xVar, yVar, categoryVar) {
            switch(type) {
                case 'histogram':
                    return xVar;
                case 'pie':
                    return categoryVar;
                case 'scatter':
                    return `X: ${xVar}, Y: ${yVar}`;
                case 'bar':
                case 'line':
                    return `X: ${xVar}, Y: ${yVar}`;
                default:
                    return '';
            }
        }

        function generateCustomChart(canvas, type, xVar, yVar, categoryVar, title) {
            if (typeof Chart === 'undefined') {
                console.error('Chart.js no est√° disponible');
                canvas.parentElement.innerHTML = '<p style="color: red;">Error: Chart.js no se pudo cargar</p>';
                return;
            }

            // Filtrar datos por columnas seleccionadas
            const filteredData = csvData.map(row => {
                const filteredRow = {};
                selectedColumns.forEach(col => {
                    filteredRow[col] = row[col];
                });
                return filteredRow;
            });

            switch(type) {
                case 'histogram':
                    createCustomHistogram(canvas, filteredData, xVar, title);
                    break;
                case 'pie':
                    createCustomPieChart(canvas, filteredData, categoryVar, title);
                    break;
                case 'scatter':
                    createCustomScatterPlot(canvas, filteredData, xVar, yVar, title);
                    break;
                case 'bar':
                    createCustomBarChart(canvas, filteredData, xVar, yVar, title);
                    break;
                case 'line':
                    createCustomLineChart(canvas, filteredData, xVar, yVar, title);
                    break;
            }
        }

        function createCustomHistogram(canvas, data, variable, title) {
            const values = data.map(row => Number(row[variable])).filter(val => !isNaN(val));
            if (values.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos num√©ricos v√°lidos para esta variable.</p>';
                return;
            }

            const min = Math.min(...values);
            const max = Math.max(...values);
            const bins = 20;
            const binWidth = (max - min) / bins;
            
            const histogram = new Array(bins).fill(0);
            const labels = [];

            for (let i = 0; i < bins; i++) {
                const binStart = min + i * binWidth;
                const binEnd = min + (i + 1) * binWidth;
                labels.push(`${binStart.toFixed(1)}`);
                histogram[i] = values.filter(val => val >= binStart && (i === bins - 1 ? val <= binEnd : val < binEnd)).length;
            }

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Frecuencia',
                        data: histogram,
                        backgroundColor: 'rgba(72, 187, 120, 0.7)',
                        borderColor: 'rgba(72, 187, 120, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Frecuencia'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: variable
                            }
                        }
                    }
                }
            });
        }

        function createCustomPieChart(canvas, data, variable, title) {
            const values = data.map(row => row[variable]).filter(val => val !== null && val !== undefined && val !== '');
            const counts = _.countBy(values);
            const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            if (sortedCounts.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para esta variable.</p>';
                return;
            }

            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 205, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)',
                'rgba(83, 102, 255, 0.8)',
                'rgba(255, 99, 255, 0.8)',
                'rgba(99, 255, 132, 0.8)'
            ];

            new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: sortedCounts.map(item => item[0]),
                    datasets: [{
                        data: sortedCounts.map(item => item[1]),
                        backgroundColor: colors.slice(0, sortedCounts.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        },
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function createCustomScatterPlot(canvas, data, xVar, yVar, title) {
            const points = data.map(row => ({
                x: Number(row[xVar]),
                y: Number(row[yVar])
            })).filter(point => !isNaN(point.x) && !isNaN(point.y));

            if (points.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos num√©ricos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: `${xVar} vs ${yVar}`,
                        data: points,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xVar
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yVar
                            }
                        }
                    }
                }
            });
        }

        function createCustomBarChart(canvas, data, xVar, yVar, title) {
            // Agrupar datos por la variable X
            const groupedData = _.groupBy(data, xVar);
            const chartData = Object.entries(groupedData).map(([key, values]) => {
                const numericValues = values.map(v => Number(v[yVar])).filter(v => !isNaN(v));
                return {
                    label: key,
                    value: numericValues.length > 0 ? _.mean(numericValues) : 0
                };
            }).sort((a, b) => b.value - a.value).slice(0, 15);

            if (chartData.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.label),
                    datasets: [{
                        label: `Promedio de ${yVar}`,
                        data: chartData.map(item => item.value),
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Promedio de ${yVar}`
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: xVar
                            }
                        }
                    }
                }
            });
        }

        function createCustomLineChart(canvas, data, xVar, yVar, title) {
            // Ordenar datos por X y agrupar si es necesario
            const sortedData = data.filter(row => 
                row[xVar] !== null && row[xVar] !== undefined && 
                row[yVar] !== null && row[yVar] !== undefined && !isNaN(Number(row[yVar]))
            ).sort((a, b) => {
                if (dataTypes[xVar] === 'numeric') {
                    return Number(a[xVar]) - Number(b[xVar]);
                }
                return a[xVar].localeCompare(b[xVar]);
            }).slice(0, 50); // Limitar a 50 puntos para mejor rendimiento

            if (sortedData.length === 0) {
                canvas.parentElement.innerHTML = '<p style="color: red;">No hay datos v√°lidos para estas variables.</p>';
                return;
            }

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: sortedData.map(row => row[xVar]),
                    datasets: [{
                        label: yVar,
                        data: sortedData.map(row => Number(row[yVar])),
                        borderColor: 'rgba(245, 101, 101, 1)',
                        backgroundColor: 'rgba(245, 101, 101, 0.1)',
                        tension: 0.1,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: title
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xVar
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yVar
                            }
                        }
                    }
                }
            });
        }

        function deleteCustomChart(button) {
            const chartItem = button.closest('.custom-chart-item');
            chartItem.remove();

            // Si no hay m√°s gr√°ficas, mostrar mensaje
            if (customChartsContainer.children.length === 0) {
                customChartsContainer.innerHTML = `
                    <div class="no-charts-message">
                        <p>üéØ Crea tu primera gr√°fica personalizada seleccionando el tipo y las variables!</p>
                    </div>
                `;
            }
            
            // Actualizar lista de exportaci√≥n
            updateIndividualChartsExport();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Funciones de exportaci√≥n
        function prepareExportOptions() {
            // Habilitar botones de exportaci√≥n b√°sicos
            document.querySelectorAll('.export-button:not(#generatePDFReport)').forEach(btn => btn.disabled = false);
            
            // Verificar disponibilidad de jsPDF y ajustar bot√≥n PDF
            const pdfButton = document.getElementById('generatePDFReport');
            const html2canvasAvailable = typeof html2canvas !== 'undefined';
            
            if (typeof window.jsPDF === 'undefined') {
                pdfButton.disabled = true;
                pdfButton.style.opacity = '0.5';
                pdfButton.innerHTML = html2canvasAvailable ? 'üìÑ PDF (HTML Alternativo)' : '‚ùå PDF No Disponible';
                pdfButton.title = html2canvasAvailable ? 
                    'jsPDF no disponible. Haz clic para generar HTML optimizado para conversi√≥n a PDF' : 
                    'jsPDF no est√° disponible y html2canvas tampoco. Usa exportaci√≥n HTML b√°sica.';
                
                // Agregar mensaje informativo
                const pdfCard = pdfButton.closest('.export-card');
                if (pdfCard && !pdfCard.querySelector('.pdf-warning')) {
                    const warning = document.createElement('div');
                    warning.className = 'pdf-warning';
                    warning.style.cssText = `
                        background: ${html2canvasAvailable ? '#e6fffa' : '#fed7d7'}; 
                        color: ${html2canvasAvailable ? '#234e52' : '#c53030'}; 
                        padding: 12px; border-radius: 6px; 
                        border: 1px solid ${html2canvasAvailable ? '#38b2ac' : '#fc8181'};
                        margin-top: 15px; font-size: 0.9em; line-height: 1.4;
                    `;
                    
                    if (html2canvasAvailable) {
                        warning.innerHTML = `
                            <strong>‚ú® Alternativa Disponible:</strong><br>
                            ‚Ä¢ html2canvas est√° funcionando<br>
                            ‚Ä¢ Puedes generar HTML optimizado para PDF<br>
                            ‚Ä¢ Usa Ctrl+P ‚Üí "Guardar como PDF" para convertir<br>
                            ‚Ä¢ Calidad profesional garantizada
                        `;
                        pdfButton.disabled = false;
                        pdfButton.style.opacity = '0.8';
                    } else {
                        warning.innerHTML = `
                            <strong>‚ÑπÔ∏è Informaci√≥n:</strong><br>
                            ‚Ä¢ jsPDF y html2canvas no disponibles<br>
                            ‚Ä¢ Usa exportaci√≥n HTML b√°sica<br>
                            ‚Ä¢ Luego imprime como PDF desde el navegador
                        `;
                    }
                    pdfCard.appendChild(warning);
                }
            } else {
                pdfButton.disabled = false;
                pdfButton.style.opacity = '1';
                pdfButton.innerHTML = 'üìë Generar Reporte PDF';
                pdfButton.title = 'Generar un reporte PDF profesional con gr√°ficos integrados';
                
                // Remover advertencia si existe
                const warning = document.querySelector('.pdf-warning');
                if (warning) warning.remove();
            }
            
            // Actualizar botones de exportaci√≥n de gr√°ficos seg√∫n html2canvas
            const chartButtons = document.querySelectorAll('#exportAllCharts, #exportCustomCharts');
            chartButtons.forEach(btn => {
                if (html2canvasAvailable) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    if (!btn.originalTitle) btn.originalTitle = btn.title;
                    btn.title = btn.originalTitle;
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.title = 'html2canvas no disponible - exportaci√≥n de gr√°ficos limitada';
                }
            });
            
            // Preparar lista de gr√°ficos individuales
            updateIndividualChartsExport();
            
            console.log('üéõÔ∏è Exportaci√≥n configurada:', {
                'PDF nativo': typeof window.jsPDF !== 'undefined' ? '‚úÖ' : '‚ùå',
                'HTML‚ÜíPDF': html2canvasAvailable ? '‚úÖ' : '‚ùå', 
                'Gr√°ficos PNG': html2canvasAvailable ? '‚úÖ' : '‚ùå',
                'Datos CSV': '‚úÖ',
                'HTML b√°sico': '‚úÖ'
            });
        }

        function updateIndividualChartsExport() {
            const chartElements = document.querySelectorAll('canvas[id^="chart-"], canvas[id^="custom-chart-"]');
            
            if (chartElements.length === 0) {
                individualChartsExport.innerHTML = '<p><em>No hay gr√°ficos disponibles para exportar</em></p>';
                return;
            }

            let html = '<h5>Gr√°ficos disponibles:</h5>';
            chartElements.forEach((canvas, index) => {
                const title = getChartTitle(canvas);
                html += `
                    <div class="chart-export-item">
                        <span class="chart-export-name">${title}</span>
                        <button class="export-button secondary" onclick="exportSingleChart('${canvas.id}', '${title}')">
                            üñºÔ∏è Exportar PNG
                        </button>
                    </div>
                `;
            });
            
            individualChartsExport.innerHTML = html;
        }

        function getChartTitle(canvas) {
            const container = canvas.closest('.chart-container, .custom-chart-item');
            if (container) {
                const titleElement = container.querySelector('.chart-title, .custom-chart-title');
                if (titleElement) {
                    return titleElement.textContent;
                }
            }
            return `Gr√°fico ${canvas.id}`;
        }

        function downloadFile(content, filename, type = 'text/csv') {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function exportData(type) {
            if (!analysisData) {
                showError('No hay datos para exportar. Realiza primero un an√°lisis.');
                return;
            }

            const messages = {
                'filtered': { title: 'Exportando datos filtrados...', message: 'Preparando archivo CSV con las columnas seleccionadas' },
                'statistics': { title: 'Exportando estad√≠sticas...', message: 'Generando resumen estad√≠stico en formato CSV' },
                'correlations': { title: 'Exportando correlaciones...', message: 'Calculando matriz de correlaciones para exportar' }
            };

            const msg = messages[type] || messages['filtered'];
            showLoading(true, msg.title, msg.message);

            setTimeout(() => {
                try {
                    let csvContent = '';
                    let filename = '';

                    switch(type) {
                        case 'filtered':
                            csvContent = generateCSVFromData(analysisData.filtered);
                            filename = 'datos_filtrados.csv';
                            break;
                        case 'statistics':
                            csvContent = generateStatisticsCSV();
                            filename = 'estadisticas.csv';
                            break;
                        case 'correlations':
                            csvContent = generateCorrelationsCSV();
                            filename = 'correlaciones.csv';
                            break;
                    }

                    downloadFile(csvContent, filename);
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showError('Error al exportar los datos: ' + error.message);
                }
            }, 300);
        }

        function generateCSVFromData(data) {
            if (!data || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (value === null || value === undefined) value = '';
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });
            
            return csvRows.join('\n');
        }

        function generateStatisticsCSV() {
            let csvContent = 'Variable,M√©trica,Valor\n';
            
            analysisData.columns.forEach(column => {
                if (dataTypes[column] === 'numeric') {
                    const values = analysisData.filtered.map(row => Number(row[column])).filter(val => !isNaN(val));
                    if (values.length > 0) {
                        const sorted = values.sort((a, b) => a - b);
                        const stats = {
                            'Cantidad': values.length,
                            'Media': _.mean(values),
                            'Mediana': sorted[Math.floor(sorted.length / 2)],
                            'Desv. Est√°ndar': Math.sqrt(_.mean(values.map(x => Math.pow(x - _.mean(values), 2)))),
                            'M√≠nimo': _.min(values),
                            'M√°ximo': _.max(values),
                            'Q1 (25%)': sorted[Math.floor(sorted.length * 0.25)],
                            'Q3 (75%)': sorted[Math.floor(sorted.length * 0.75)]
                        };
                        
                        Object.entries(stats).forEach(([metric, value]) => {
                            csvContent += `"${column}","${metric}",${value}\n`;
                        });
                    }
                }
            });
            
            return csvContent;
        }

        function generateCorrelationsCSV() {
            const numericColumns = analysisData.columns.filter(col => dataTypes[col] === 'numeric');
            if (numericColumns.length < 2) return 'Variable1,Variable2,Correlaci√≥n\n';

            let csvContent = 'Variable1,Variable2,Correlaci√≥n\n';
            
            for (let i = 0; i < numericColumns.length; i++) {
                for (let j = i + 1; j < numericColumns.length; j++) {
                    const col1 = numericColumns[i];
                    const col2 = numericColumns[j];
                    
                    const values1 = analysisData.filtered.map(row => Number(row[col1])).filter(val => !isNaN(val));
                    const values2 = analysisData.filtered.map(row => Number(row[col2])).filter(val => !isNaN(val));
                    const correlation = calculateCorrelation(values1, values2);
                    
                    csvContent += `"${col1}","${col2}",${correlation.toFixed(3)}\n`;
                }
            }
            
            return csvContent;
        }

        function exportCharts(type) {
            const title = type === 'all' ? 'Exportando todos los gr√°ficos...' : 'Exportando gr√°ficos personalizados...';
            const message = 'Convirtiendo gr√°ficos a im√°genes PNG de alta calidad';
            
            showLoading(true, title, message);
            
            setTimeout(() => {
                try {
                    const quality = parseFloat(document.getElementById('imageQuality').value);
                    const charts = [];
                    
                    if (type === 'all') {
                        document.querySelectorAll('canvas[id^="chart-"], canvas[id^="custom-chart-"]').forEach(canvas => {
                            charts.push({
                                name: getChartTitle(canvas),
                                data: canvas.toDataURL('image/png', quality)
                            });
                        });
                    } else if (type === 'custom') {
                        document.querySelectorAll('canvas[id^="custom-chart-"]').forEach(canvas => {
                            charts.push({
                                name: getChartTitle(canvas),
                                data: canvas.toDataURL('image/png', quality)
                            });
                        });
                    }
                    
                    if (charts.length === 0) {
                        showError('No hay gr√°ficos disponibles para exportar.');
                        showLoading(false);
                        return;
                    }
                    
                    // Crear y descargar archivos
                    charts.forEach((chart, index) => {
                        const link = document.createElement('a');
                        link.download = `${chart.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                        link.href = chart.data;
                        document.body.appendChild(link);
                        
                        setTimeout(() => {
                            link.click();
                            document.body.removeChild(link);
                        }, index * 100);
                    });
                    
                    showLoading(false);
                } catch (error) {
                    showLoading(false);
                    showError('Error al exportar los gr√°ficos: ' + error.message);
                }
            }, 300);
        }

        function exportSingleChart(canvasId, title) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    showError('Gr√°fico no encontrado.');
                    return;
                }
                
                const quality = parseFloat(document.getElementById('imageQuality').value);
                const link = document.createElement('a');
                link.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
                link.href = canvas.toDataURL('image/png', quality);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                showError('Error al exportar el gr√°fico: ' + error.message);
            }
        }

        function generateReport(format) {
            if (!analysisData) {
                showError('No hay datos para generar el reporte. Realiza primero un an√°lisis.');
                return;
            }

            if (format === 'pdf' && typeof window.jsPDF === 'undefined') {
                // Ofrecer alternativa HTML para impresi√≥n
                const userConfirm = confirm(
                    'üìÑ PDF no disponible\n\n' +
                    'La exportaci√≥n directa a PDF no est√° disponible debido a un problema t√©cnico.\n\n' +
                    '¬øDeseas generar un reporte HTML optimizado para impresi√≥n?\n' +
                    'Podr√°s convertirlo a PDF usando Ctrl+P ‚Üí "Guardar como PDF" en tu navegador.'
                );
                
                if (!userConfirm) {
                    return;
                }
                
                // Generar HTML optimizado para impresi√≥n
                format = 'html-print';
            }

            const title = format === 'pdf' ? 'Generando PDF...' : 
                         format === 'html-print' ? 'Generando HTML para impresi√≥n...' : 
                         'Generando HTML...';
            const message = format === 'pdf' ? 
                'Creando PDF con gr√°ficos de alta calidad. Esto puede tomar unos segundos...' : 
                format === 'html-print' ?
                'Preparando reporte HTML optimizado para convertir a PDF...' :
                'Preparando reporte HTML...';
            
            showLoading(true, title, message);

            setTimeout(() => {
                try {
                    const reportConfig = getReportConfig();
                    
                    if (format === 'html' || format === 'html-print') {
                        const htmlReport = generateHTMLReportContent(reportConfig, format === 'html-print');
                        const filename = format === 'html-print' ? 
                            `${reportConfig.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_para_impresion.html` :
                            `${reportConfig.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html`;
                        
                        downloadFile(htmlReport, filename, 'text/html');
                        showLoading(false);
                        
                        if (format === 'html-print') {
                            setTimeout(() => {
                                alert(
                                    '‚úÖ Reporte generado exitosamente\n\n' +
                                    'üìã Instrucciones para convertir a PDF:\n' +
                                    '1. Abre el archivo HTML descargado\n' +
                                    '2. Presiona Ctrl+P (Cmd+P en Mac)\n' +
                                    '3. Selecciona "Guardar como PDF"\n' +
                                    '4. Ajusta los m√°rgenes si es necesario\n\n' +
                                    'üí° El reporte est√° optimizado para impresi√≥n'
                                );
                            }, 500);
                        }
                    } else if (format === 'pdf') {
                        generatePDFReportFunction(reportConfig);
                    }
                } catch (error) {
                    showLoading(false);
                    showError('Error al generar el reporte: ' + error.message);
                }
            }, 500);
        }

        async function generatePDFReportFunction(config) {
            try {
                // Verificar que jsPDF est√© disponible
                if (typeof window.jsPDF === 'undefined') {
                    throw new Error('jsPDF no est√° disponible');
                }

                const { jsPDF } = window.jsPDF;
                const pdf = new jsPDF('p', 'mm', 'a4');
                let yPosition = 20;
                const pageHeight = pdf.internal.pageSize.height;
                const pageWidth = pdf.internal.pageSize.width;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);

                // Funci√≥n para agregar nueva p√°gina si es necesario
                const checkPageBreak = (neededHeight) => {
                    if (yPosition + neededHeight > pageHeight - 20) {
                        pdf.addPage();
                        yPosition = 20;
                        return true;
                    }
                    return false;
                };

                // Header del reporte
                pdf.setFontSize(24);
                pdf.setTextColor(102, 126, 234);
                pdf.text(config.title, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                pdf.setFontSize(12);
                pdf.setTextColor(102, 102, 102);
                pdf.text(`Autor: ${config.author}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 8;
                pdf.text(`Fecha: ${config.date}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 8;
                pdf.text(`Dataset: ${csvFileInput.files[0]?.name || 'Datos analizados'}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                // L√≠nea separadora
                pdf.setLineWidth(0.5);
                pdf.setDrawColor(102, 126, 234);
                pdf.line(margin, yPosition, pageWidth - margin, yPosition);
                yPosition += 15;

                // Resumen General
                if (config.includeOverview) {
                    checkPageBreak(30);
                    pdf.setFontSize(16);
                    pdf.setTextColor(45, 55, 72);
                    pdf.text('üìä Resumen General', margin, yPosition);
                    yPosition += 12;

                    const overviewData = getOverviewDataForPDF();
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    overviewData.forEach(item => {
                        checkPageBreak(8);
                        pdf.text(`‚Ä¢ ${item.label}: ${item.value}`, margin + 5, yPosition);
                        yPosition += 6;
                    });
                    yPosition += 10;
                }

                // Estad√≠sticas
                if (config.includeStatistics) {
                    checkPageBreak(30);
                    pdf.setFontSize(16);
                    pdf.setTextColor(45, 55, 72);
                    pdf.text('üìà Estad√≠sticas Descriptivas', margin, yPosition);
                    yPosition += 12;

                    const statisticsData = getStatisticsDataForPDF();
                    pdf.setFontSize(10);
                    
                    statisticsData.forEach(columnStats => {
                        checkPageBreak(25);
                        pdf.setFont(undefined, 'bold');
                        pdf.text(columnStats.column, margin + 5, yPosition);
                        yPosition += 8;
                        
                        pdf.setFont(undefined, 'normal');
                        columnStats.stats.forEach(stat => {
                            checkPageBreak(6);
                            pdf.text(`  ‚Ä¢ ${stat.label}: ${stat.value}`, margin + 10, yPosition);
                            yPosition += 5;
                        });
                        yPosition += 5;
                    });
                    yPosition += 10;
                }

                // Gr√°ficos
                if (config.includeVisualizations || config.includeCustomCharts) {
                    await addChartsToPDF(pdf, config, pageWidth, pageHeight, margin, contentWidth);
                }

                // Correlaciones (como tabla)
                if (config.includeCorrelations) {
                    await addCorrelationsToPDF(pdf, pageWidth, pageHeight, margin);
                }

                // Calidad de datos
                if (config.includeQuality) {
                    await addQualityDataToPDF(pdf, pageWidth, pageHeight, margin);
                }

                // Footer
                const totalPages = pdf.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(128, 128, 128);
                    pdf.text(`P√°gina ${i} de ${totalPages} - Generado por Analizador EDA`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                }

                // Descargar PDF
                const filename = `${config.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`;
                pdf.save(filename);
                showLoading(false);

            } catch (error) {
                showLoading(false);
                showError('Error al generar PDF: ' + error.message);
                console.error('PDF Error:', error);
            }
        }

        function getOverviewDataForPDF() {
            return [
                { label: 'Total de filas', value: analysisData.filtered.length.toLocaleString() },
                { label: 'Columnas analizadas', value: analysisData.columns.length },
                { label: 'Columnas num√©ricas', value: analysisData.columns.filter(col => dataTypes[col] === 'numeric').length },
                { label: 'Columnas categ√≥ricas', value: analysisData.columns.filter(col => dataTypes[col] === 'categorical').length }
            ];
        }

        function getStatisticsDataForPDF() {
            const stats = [];
            
            analysisData.columns.forEach(column => {
                const values = analysisData.filtered.map(row => row[column]).filter(val => val !== null && val !== undefined && val !== '');
                
                if (dataTypes[column] === 'numeric') {
                    const numericValues = values.map(Number).filter(val => !isNaN(val));
                    if (numericValues.length > 0) {
                        const sorted = numericValues.sort((a, b) => a - b);
                        const columnStats = {
                            column: column,
                            stats: [
                                { label: 'Cantidad', value: numericValues.length },
                                { label: 'Media', value: _.mean(numericValues).toFixed(2) },
                                { label: 'Mediana', value: sorted[Math.floor(sorted.length / 2)].toFixed(2) },
                                { label: 'M√≠nimo', value: _.min(numericValues) },
                                { label: 'M√°ximo', value: _.max(numericValues) }
                            ]
                        };
                        stats.push(columnStats);
                    }
                } else {
                    const counts = _.countBy(values);
                    const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                    const columnStats = {
                        column: `${column} (Categ√≥rica)`,
                        stats: [
                            { label: 'Valores √∫nicos', value: Object.keys(counts).length },
                            { label: 'M√°s frecuente', value: `${sortedCounts[0][0]} (${sortedCounts[0][1]})` }
                        ]
                    };
                    stats.push(columnStats);
                }
            });
            
            return stats;
        }

        async function addChartsToPDF(pdf, config, pageWidth, pageHeight, margin, contentWidth) {
            const charts = [];
            
            // Recopilar gr√°ficos
            if (config.includeVisualizations) {
                document.querySelectorAll('canvas[id^="chart-"]').forEach(canvas => {
                    charts.push({ canvas, title: getChartTitle(canvas) });
                });
            }
            
            if (config.includeCustomCharts) {
                document.querySelectorAll('canvas[id^="custom-chart-"]').forEach(canvas => {
                    charts.push({ canvas, title: getChartTitle(canvas) });
                });
            }

            if (charts.length === 0) return;

            // Agregar t√≠tulo de secci√≥n
            pdf.addPage();
            let yPos = 20;
            pdf.setFontSize(16);
            pdf.setTextColor(45, 55, 72);
            pdf.text('üìä Visualizaciones', margin, yPos);
            yPos += 20;

            // Agregar cada gr√°fico
            for (const chart of charts) {
                if (yPos > pageHeight - 120) { // Espacio m√≠nimo para un gr√°fico
                    pdf.addPage();
                    yPos = 20;
                }

                try {
                    // T√≠tulo del gr√°fico
                    pdf.setFontSize(12);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(chart.title, margin, yPos);
                    yPos += 10;

                    // Convertir canvas a imagen
                    const quality = parseFloat(document.getElementById('imageQuality').value);
                    const imgData = chart.canvas.toDataURL('image/png', quality);
                    
                    // Calcular dimensiones manteniendo aspecto
                    const imgWidth = contentWidth * 0.8; // 80% del ancho disponible
                    const imgHeight = (chart.canvas.height / chart.canvas.width) * imgWidth;
                    
                    // Agregar imagen al PDF
                    const xPos = margin + (contentWidth - imgWidth) / 2; // Centrar
                    pdf.addImage(imgData, 'PNG', xPos, yPos, imgWidth, imgHeight);
                    yPos += imgHeight + 15;

                } catch (error) {
                    console.error('Error adding chart to PDF:', error);
                    pdf.setFontSize(10);
                    pdf.setTextColor(255, 0, 0);
                    pdf.text('Error al cargar gr√°fico', margin, yPos);
                    yPos += 10;
                }
            }
        }

        async function addCorrelationsToPDF(pdf, pageWidth, pageHeight, margin) {
            const numericColumns = analysisData.columns.filter(col => dataTypes[col] === 'numeric');
            if (numericColumns.length < 2) return;

            pdf.addPage();
            let yPos = 20;
            
            pdf.setFontSize(16);
            pdf.setTextColor(45, 55, 72);
            pdf.text('üîó Matriz de Correlaciones', margin, yPos);
            yPos += 20;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);

            // Crear tabla de correlaciones
            for (let i = 0; i < numericColumns.length; i++) {
                for (let j = i + 1; j < numericColumns.length; j++) {
                    if (yPos > pageHeight - 30) {
                        pdf.addPage();
                        yPos = 20;
                    }

                    const col1 = numericColumns[i];
                    const col2 = numericColumns[j];
                    
                    const values1 = analysisData.filtered.map(row => Number(row[col1])).filter(val => !isNaN(val));
                    const values2 = analysisData.filtered.map(row => Number(row[col2])).filter(val => !isNaN(val));
                    const correlation = calculateCorrelation(values1, values2);
                    
                    pdf.text(`${col1} ‚Üî ${col2}: ${correlation.toFixed(3)}`, margin, yPos);
                    yPos += 6;
                }
            }
        }

        async function addQualityDataToPDF(pdf, pageWidth, pageHeight, margin) {
            pdf.addPage();
            let yPos = 20;
            
            pdf.setFontSize(16);
            pdf.setTextColor(45, 55, 72);
            pdf.text('üîç An√°lisis de Calidad de Datos', margin, yPos);
            yPos += 20;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);

            analysisData.columns.forEach(column => {
                if (yPos > pageHeight - 40) {
                    pdf.addPage();
                    yPos = 20;
                }

                const totalRows = analysisData.filtered.length;
                const values = analysisData.filtered.map(row => row[column]);
                const nullValues = values.filter(val => val === null || val === undefined || val === '').length;
                const validValues = totalRows - nullValues;
                const uniqueValues = new Set(values.filter(val => val !== null && val !== undefined && val !== '')).size;

                pdf.setFont(undefined, 'bold');
                pdf.text(column, margin, yPos);
                yPos += 8;
                
                pdf.setFont(undefined, 'normal');
                pdf.text(`‚Ä¢ Valores v√°lidos: ${validValues} (${(validValues/totalRows*100).toFixed(1)}%)`, margin + 5, yPos);
                yPos += 5;
                pdf.text(`‚Ä¢ Valores faltantes: ${nullValues} (${(nullValues/totalRows*100).toFixed(1)}%)`, margin + 5, yPos);
                yPos += 5;
                pdf.text(`‚Ä¢ Valores √∫nicos: ${uniqueValues}`, margin + 5, yPos);
                yPos += 10;
            });
        }

        function getReportConfig() {
            return {
                title: document.getElementById('reportTitle').value || 'An√°lisis EDA',
                author: document.getElementById('authorName').value || 'Usuario',
                date: new Date().toLocaleDateString('es-ES'),
                includeOverview: document.getElementById('includeOverview').checked,
                includeStatistics: document.getElementById('includeStatistics').checked,
                includeVisualizations: document.getElementById('includeVisualizations').checked,
                includeCustomCharts: document.getElementById('includeCustomCharts').checked,
                includeCorrelations: document.getElementById('includeCorrelations').checked,
                includeQuality: document.getElementById('includeQuality').checked
            };
        }

        function generateHTMLReportContent(config, forPrint = false) {
            const quality = parseFloat(document.getElementById('imageQuality').value);
            const printStyles = forPrint ? `
                @media screen {
                    body { background: white; }
                    .print-instructions {
                        background: #e6fffa; border: 2px solid #38b2ac; color: #234e52;
                        padding: 20px; margin: 20px 0; border-radius: 8px; text-align: center;
                        font-weight: bold; page-break-inside: avoid;
                    }
                }
                @media print {
                    body { margin: 15mm; font-size: 11pt; }
                    .print-instructions { display: none; }
                    .section { page-break-inside: avoid; margin-bottom: 15mm; }
                    .chart-container { page-break-inside: avoid; margin: 10mm 0; }
                    .header { page-break-after: avoid; }
                    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
                    .stat-card { break-inside: avoid; }
                }
            ` : '';
            
            let html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${config.title}</title>
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; color: #333; line-height: 1.4; }
                        .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #667eea; }
                        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
                        .meta { color: #666; font-size: 1.1em; }
                        .section { margin: 30px 0; page-break-inside: avoid; }
                        .section h2 { color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
                        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
                        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; break-inside: avoid; }
                        .stat-item { display: flex; justify-content: space-between; margin: 8px 0; padding: 5px 0; border-bottom: 1px solid #e2e8f0; }
                        .chart-container { text-align: center; margin: 30px 0; page-break-inside: avoid; }
                        .chart-image { max-width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
                        .correlation-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        .correlation-table th, .correlation-table td { padding: 8px 12px; text-align: center; border: 1px solid #e2e8f0; font-size: 0.9em; }
                        .correlation-table th { background: #f7fafc; }
                        ${printStyles}
                    </style>
                </head>
                <body>
                    ${forPrint ? `
                        <div class="print-instructions">
                            <strong>üìã Instrucciones:</strong> Este reporte est√° optimizado para impresi√≥n.<br>
                            Presiona <kbd>Ctrl+P</kbd> (o <kbd>Cmd+P</kbd> en Mac) y selecciona "Guardar como PDF" para convertirlo.
                        </div>
                    ` : ''}
                    <div class="header">
                        <h1>${config.title}</h1>
                        <div class="meta">
                            <p><strong>Autor:</strong> ${config.author}</p>
                            <p><strong>Fecha:</strong> ${config.date}</p>
                            <p><strong>Dataset:</strong> ${csvFileInput.files[0]?.name || 'Datos analizados'}</p>
                        </div>
                    </div>
            `;

            // Incluir secciones seg√∫n configuraci√≥n
            if (config.includeOverview) {
                html += generateReportSection('Resumen General', 'overviewContent');
            }
            
            if (config.includeStatistics) {
                html += generateReportSection('Estad√≠sticas Descriptivas', 'statisticsContent');
            }
            
            if (config.includeVisualizations || config.includeCustomCharts) {
                html += '<div class="section"><h2>üìä Visualizaciones</h2>';
                
                if (config.includeVisualizations) {
                    document.querySelectorAll('canvas[id^="chart-"]').forEach(canvas => {
                        const title = getChartTitle(canvas);
                        const imageData = canvas.toDataURL('image/png', quality);
                        html += `
                            <div class="chart-container">
                                <h3>${title}</h3>
                                <img src="${imageData}" alt="${title}" class="chart-image" />
                            </div>
                        `;
                    });
                }
                
                if (config.includeCustomCharts) {
                    document.querySelectorAll('canvas[id^="custom-chart-"]').forEach(canvas => {
                        const title = getChartTitle(canvas);
                        const imageData = canvas.toDataURL('image/png', quality);
                        html += `
                            <div class="chart-container">
                                <h3>${title}</h3>
                                <img src="${imageData}" alt="${title}" class="chart-image" />
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
            }
            
            if (config.includeCorrelations) {
                html += generateReportSection('Matriz de Correlaciones', 'correlationsContent');
            }
            
            if (config.includeQuality) {
                html += generateReportSection('An√°lisis de Calidad de Datos', 'qualityContent');
            }

            html += `
                    <div class="section" style="margin-top: 50px; text-align: center; color: #666; font-size: 0.9em;">
                        <p>Reporte generado por Analizador EDA - ${new Date().toLocaleString('es-ES')}</p>
                        ${forPrint ? '<p style="margin-top: 10px;"><em>Optimizado para impresi√≥n y conversi√≥n a PDF</em></p>' : ''}
                    </div>
                </body>
                </html>
            `;

            return html;
        }

        function generateReportSection(title, contentId) {
            const contentElement = document.getElementById(contentId);
            if (!contentElement) return '';
            
            // Clonar el contenido y limpiarlo para el reporte
            const clonedContent = contentElement.cloneNode(true);
            
            // Remover elementos no deseados
            clonedContent.querySelectorAll('.loading, button, .delete-chart-button').forEach(el => el.remove());
            
            return `
                <div class="section">
                    <h2>${title}</h2>
                    ${clonedContent.innerHTML}
                </div>
            `;
        }
    </script>
</body>
</html>
